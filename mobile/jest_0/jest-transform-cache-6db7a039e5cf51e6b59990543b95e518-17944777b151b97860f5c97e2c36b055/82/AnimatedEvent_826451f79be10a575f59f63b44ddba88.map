{"version":3,"sources":["AnimatedEvent.js"],"names":["AnimatedValue","require","NativeAnimatedHelper","ReactNative","invariant","shouldUseNativeDriver","attachNativeEvent","viewRef","eventName","argMapping","eventMappings","traverse","value","path","__makeNative","push","nativeEventPath","animatedValueTag","__getNativeTag","key","concat","nativeEvent","viewTag","findNodeHandle","forEach","API","addAnimatedEventToView","mapping","detach","removeAnimatedEventFromView","AnimatedEvent","config","_listeners","_argMapping","listener","__addListener","_callListeners","bind","_attachedEvent","__isNative","__DEV__","_validateMapping","callback","filter","args","recMapping","recEvt","setValue","mappingKey","idx","module","exports"],"mappings":"AAUA,a,uzBAEA,GAAMA,eAAgBC,QAAQ,uBAAR,CAAtB,CACA,GAAMC,sBAAuBD,QAAQ,wBAAR,CAA7B,CACA,GAAME,aAAcF,OAAd,eAAN,CAEA,GAAMG,WAAYH,OAAZ,sBAAN,C,aACgCA,QAAQ,wBAAR,C,CAAzBI,qB,UAAAA,qB,CAQP,QAASC,kBAAT,CACEC,OADF,CAEEC,SAFF,CAGEC,UAHF,CAIE,CAGA,GAAMC,eAAgB,EAAtB,CAEA,GAAMC,UAAW,QAAXA,SAAW,CAACC,KAAD,CAAQC,IAAR,CAAiB,CAChC,GAAID,gBAAiBZ,cAArB,CAAoC,CAClCY,MAAME,YAAN,GAEAJ,cAAcK,IAAd,CAAmB,CACjBC,gBAAiBH,IADA,CAEjBI,iBAAkBL,MAAMM,cAAN,EAFD,CAAnB,EAID,CAPD,IAOO,IAAI,MAAON,MAAP,GAAiB,QAArB,CAA+B,CACpC,IAAK,GAAMO,KAAX,GAAkBP,MAAlB,CAAyB,CACvBD,SAASC,MAAMO,IAAN,CAAT,CAAqBN,KAAKO,MAAL,CAAYD,IAAZ,CAArB,EACD,CACF,CACF,CAbD,CAeAf,UACEK,WAAW,CAAX,GAAiBA,WAAW,CAAX,EAAcY,WADjC,CAEE,mFAFF,EAMAV,SAASF,WAAW,CAAX,EAAcY,WAAvB,CAAoC,EAApC,EAEA,GAAMC,SAAUnB,YAAYoB,cAAZ,CAA2BhB,OAA3B,CAAhB,CAEAG,cAAcc,OAAd,CAAsB,iBAAW,CAC/BtB,qBAAqBuB,GAArB,CAAyBC,sBAAzB,CACEJ,OADF,CAEEd,SAFF,CAGEmB,OAHF,EAKD,CAND,EAQA,MAAO,CACLC,MADK,kBACI,CACPlB,cAAcc,OAAd,CAAsB,iBAAW,CAC/BtB,qBAAqBuB,GAArB,CAAyBI,2BAAzB,CACEP,OADF,CAEEd,SAFF,CAGEmB,QAAQV,gBAHV,EAKD,CAND,EAOD,CATI,CAAP,CAWD,C,GAEKa,c,YASJ,uBAAYrB,UAAZ,CAAoE,IAA3BsB,OAA2B,2DAAJ,EAAI,0CAPpEC,UAOoE,CAPtC,EAOsC,CAClE,KAAKC,WAAL,CAAmBxB,UAAnB,CACA,GAAIsB,OAAOG,QAAX,CAAqB,CACnB,KAAKC,aAAL,CAAmBJ,OAAOG,QAA1B,EACD,CACD,KAAKE,cAAL,CAAsB,KAAKA,cAAL,CAAoBC,IAApB,CAAyB,IAAzB,CAAtB,CACA,KAAKC,cAAL,CAAsB,IAAtB,CACA,KAAKC,UAAL,CAAkBlC,sBAAsB0B,MAAtB,CAAlB,CAEA,GAAIS,OAAJ,CAAa,CACX,KAAKC,gBAAL,GACD,CACF,C,8EAEaC,Q,CAA0B,CACtC,KAAKV,UAAL,CAAgBjB,IAAhB,CAAqB2B,QAArB,EACD,C,0DAEgBA,Q,CAA0B,CACzC,KAAKV,UAAL,CAAkB,KAAKA,UAAL,CAAgBW,MAAhB,CAAuB,yBAAYT,YAAaQ,QAAzB,EAAvB,CAAlB,CACD,C,0CAEQnC,O,CAAcC,S,CAAmB,CACxCJ,UACE,KAAKmC,UADP,CAEE,gDAFF,EAKA,KAAKD,cAAL,CAAsBhC,kBACpBC,OADoB,CAEpBC,SAFoB,CAGpB,KAAKyB,WAHe,CAAtB,CAKD,C,0CAEQX,O,CAAcd,S,CAAmB,CACxCJ,UACE,KAAKmC,UADP,CAEE,gDAFF,EAKA,KAAKD,cAAL,EAAuB,KAAKA,cAAL,CAAoBV,MAApB,EAAvB,CACD,C,mDAEc,gBACb,GAAI,KAAKW,UAAT,CAAqB,CACnB,MAAO,MAAKH,cAAZ,CACD,CAED,MAAO,WAAkB,+BAAdQ,IAAc,yCAAdA,IAAc,0BACvB,GAAMjC,UAAW,QAAXA,SAAW,CAACkC,UAAD,CAAaC,MAAb,CAAqB3B,GAArB,CAA6B,CAC5C,GAAI,MAAO2B,OAAP,GAAkB,QAAlB,EAA8BD,qBAAsB7C,cAAxD,CAAuE,CACrE6C,WAAWE,QAAX,CAAoBD,MAApB,EACD,CAFD,IAEO,IAAI,MAAOD,WAAP,GAAsB,QAA1B,CAAoC,CACzC,IAAK,GAAMG,WAAX,GAAyBH,WAAzB,CAAqC,CAInClC,SAASkC,WAAWG,UAAX,CAAT,CAAiCF,OAAOE,UAAP,CAAjC,CAAqDA,UAArD,EACD,CACF,CACF,CAXD,CAaA,GAAI,CAAC,MAAKT,UAAV,CAAsB,CACpB,MAAKN,WAAL,CAAiBT,OAAjB,CAAyB,SAACG,OAAD,CAAUsB,GAAV,CAAkB,CACzCtC,SAASgB,OAAT,CAAkBiB,KAAKK,GAAL,CAAlB,CAA6B,MAAQA,GAArC,EACD,CAFD,EAGD,CACD,MAAKb,cAAL,gCAAuBQ,IAAvB,GACD,CApBD,CAqBD,C,uDAEuB,gCAANA,IAAM,2CAANA,IAAM,0BACtB,KAAKZ,UAAL,CAAgBR,OAAhB,CAAwB,yBAAYU,0BAAYU,IAAZ,CAAZ,EAAxB,EACD,C,2DAEkB,CACjB,GAAMjC,UAAW,QAAXA,SAAW,CAACkC,UAAD,CAAaC,MAAb,CAAqB3B,GAArB,CAA6B,CAC5C,GAAI,MAAO2B,OAAP,GAAkB,QAAtB,CAAgC,CAC9B1C,UACEyC,qBAAsB7C,cADxB,CAEE,uBACE,MAAO6C,WADT,CAEE,WAFF,CAGE1B,GAHF,CAIE,yCANJ,EAQA,OACD,CACDf,UACE,MAAOyC,WAAP,GAAsB,QADxB,CAEE,uBAAyB,MAAOA,WAAhC,CAA6C,WAA7C,CAA2D1B,GAF7D,EAIAf,UACE,MAAO0C,OAAP,GAAkB,QADpB,CAEE,qBAAuB,MAAOA,OAA9B,CAAuC,WAAvC,CAAqD3B,GAFvD,EAIA,IAAK,GAAM6B,WAAX,GAAyBH,WAAzB,CAAqC,CACnClC,SAASkC,WAAWG,UAAX,CAAT,CAAiCF,OAAOE,UAAP,CAAjC,CAAqDA,UAArD,EACD,CACF,CAvBD,CAwBD,C,6BAGHE,OAAOC,OAAP,CAAiB,CAACrB,2BAAD,CAAgBxB,mCAAhB,CAAjB","file":"AnimatedEvent.js","sourcesContent":["/**\n * Copyright (c) 2015-present, Facebook, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @providesModule AnimatedEvent\n * @flow\n * @format\n */\n'use strict';\n\nconst AnimatedValue = require('./nodes/AnimatedValue');\nconst NativeAnimatedHelper = require('./NativeAnimatedHelper');\nconst ReactNative = require('ReactNative');\n\nconst invariant = require('fbjs/lib/invariant');\nconst {shouldUseNativeDriver} = require('./NativeAnimatedHelper');\n\nexport type Mapping = {[key: string]: Mapping} | AnimatedValue;\nexport type EventConfig = {\n  listener?: ?Function,\n  useNativeDriver?: boolean,\n};\n\nfunction attachNativeEvent(\n  viewRef: any,\n  eventName: string,\n  argMapping: Array<?Mapping>,\n) {\n  // Find animated values in `argMapping` and create an array representing their\n  // key path inside the `nativeEvent` object. Ex.: ['contentOffset', 'x'].\n  const eventMappings = [];\n\n  const traverse = (value, path) => {\n    if (value instanceof AnimatedValue) {\n      value.__makeNative();\n\n      eventMappings.push({\n        nativeEventPath: path,\n        animatedValueTag: value.__getNativeTag(),\n      });\n    } else if (typeof value === 'object') {\n      for (const key in value) {\n        traverse(value[key], path.concat(key));\n      }\n    }\n  };\n\n  invariant(\n    argMapping[0] && argMapping[0].nativeEvent,\n    'Native driven events only support animated values contained inside `nativeEvent`.',\n  );\n\n  // Assume that the event containing `nativeEvent` is always the first argument.\n  traverse(argMapping[0].nativeEvent, []);\n\n  const viewTag = ReactNative.findNodeHandle(viewRef);\n\n  eventMappings.forEach(mapping => {\n    NativeAnimatedHelper.API.addAnimatedEventToView(\n      viewTag,\n      eventName,\n      mapping,\n    );\n  });\n\n  return {\n    detach() {\n      eventMappings.forEach(mapping => {\n        NativeAnimatedHelper.API.removeAnimatedEventFromView(\n          viewTag,\n          eventName,\n          mapping.animatedValueTag,\n        );\n      });\n    },\n  };\n}\n\nclass AnimatedEvent {\n  _argMapping: Array<?Mapping>;\n  _listeners: Array<Function> = [];\n  _callListeners: Function;\n  _attachedEvent: ?{\n    detach: () => void,\n  };\n  __isNative: boolean;\n\n  constructor(argMapping: Array<?Mapping>, config?: EventConfig = {}) {\n    this._argMapping = argMapping;\n    if (config.listener) {\n      this.__addListener(config.listener);\n    }\n    this._callListeners = this._callListeners.bind(this);\n    this._attachedEvent = null;\n    this.__isNative = shouldUseNativeDriver(config);\n\n    if (__DEV__) {\n      this._validateMapping();\n    }\n  }\n\n  __addListener(callback: Function): void {\n    this._listeners.push(callback);\n  }\n\n  __removeListener(callback: Function): void {\n    this._listeners = this._listeners.filter(listener => listener !== callback);\n  }\n\n  __attach(viewRef: any, eventName: string) {\n    invariant(\n      this.__isNative,\n      'Only native driven events need to be attached.',\n    );\n\n    this._attachedEvent = attachNativeEvent(\n      viewRef,\n      eventName,\n      this._argMapping,\n    );\n  }\n\n  __detach(viewTag: any, eventName: string) {\n    invariant(\n      this.__isNative,\n      'Only native driven events need to be detached.',\n    );\n\n    this._attachedEvent && this._attachedEvent.detach();\n  }\n\n  __getHandler() {\n    if (this.__isNative) {\n      return this._callListeners;\n    }\n\n    return (...args: any) => {\n      const traverse = (recMapping, recEvt, key) => {\n        if (typeof recEvt === 'number' && recMapping instanceof AnimatedValue) {\n          recMapping.setValue(recEvt);\n        } else if (typeof recMapping === 'object') {\n          for (const mappingKey in recMapping) {\n            /* $FlowFixMe(>=0.53.0 site=react_native_fb,react_native_oss) This\n             * comment suppresses an error when upgrading Flow's support for\n             * React. To see the error delete this comment and run Flow. */\n            traverse(recMapping[mappingKey], recEvt[mappingKey], mappingKey);\n          }\n        }\n      };\n\n      if (!this.__isNative) {\n        this._argMapping.forEach((mapping, idx) => {\n          traverse(mapping, args[idx], 'arg' + idx);\n        });\n      }\n      this._callListeners(...args);\n    };\n  }\n\n  _callListeners(...args) {\n    this._listeners.forEach(listener => listener(...args));\n  }\n\n  _validateMapping() {\n    const traverse = (recMapping, recEvt, key) => {\n      if (typeof recEvt === 'number') {\n        invariant(\n          recMapping instanceof AnimatedValue,\n          'Bad mapping of type ' +\n            typeof recMapping +\n            ' for key ' +\n            key +\n            ', event value must map to AnimatedValue',\n        );\n        return;\n      }\n      invariant(\n        typeof recMapping === 'object',\n        'Bad mapping of type ' + typeof recMapping + ' for key ' + key,\n      );\n      invariant(\n        typeof recEvt === 'object',\n        'Bad event of type ' + typeof recEvt + ' for key ' + key,\n      );\n      for (const mappingKey in recMapping) {\n        traverse(recMapping[mappingKey], recEvt[mappingKey], mappingKey);\n      }\n    };\n  }\n}\n\nmodule.exports = {AnimatedEvent, attachNativeEvent};\n"]}