f12e3f35f8e66ec73ac16597fda001fb
Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};exports.__waitForEmptyLogQueueAsync=__waitForEmptyLogQueueAsync;var _fbemitter=require('fbemitter');var _invariant=require('invariant');var _invariant2=_interopRequireDefault(_invariant);var _uuidJs=require('uuid-js');var _uuidJs2=_interopRequireDefault(_uuidJs);var _LogSerialization=require('./LogSerialization');var _LogSerialization2=_interopRequireDefault(_LogSerialization);var _Constants=require('../Constants');var _Constants2=_interopRequireDefault(_Constants);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var _sessionId=_uuidJs2.default.create().toString();var _logQueue=[];var _transportEventEmitter=new _fbemitter.EventEmitter();var _logCounter=0;var _isSendingLogs=false;var _completionPromise=void 0;var _resolveCompletion2=void 0;function enqueueRemoteLogAsync(level,additionalFields,data){var warning,lines,_ref,body,includesStack;return regeneratorRuntime.async(function enqueueRemoteLogAsync$(_context){while(1){switch(_context.prev=_context.next){case 0:if(_isReactNativeWarning(data)){(0,_invariant2.default)(data.length>0,'Warnings must include log arguments');(0,_invariant2.default)(typeof data[0]==='string','The log argument for a warning must be a string');warning=data[0];lines=warning.split('\n');if(lines.length>1&&/^\s+in /.test(lines[1])){data[0]=lines[0];}}_context.next=3;return regeneratorRuntime.awrap(_LogSerialization2.default.serializeLogDataAsync(data,level));case 3:_ref=_context.sent;body=_ref.body;includesStack=_ref.includesStack;_logQueue.push(_extends({count:_logCounter++,level:level,body:body,includesStack:includesStack},additionalFields));_sendRemoteLogsAsync().catch(function(error){setImmediate(function(){throw error;});});case 8:case'end':return _context.stop();}}},null,this);}function _sendRemoteLogsAsync(){var batch,logUrl;return regeneratorRuntime.async(function _sendRemoteLogsAsync$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(_isSendingLogs||!_logQueue.length)){_context2.next=2;break;}return _context2.abrupt('return');case 2:batch=_logQueue.splice(0);logUrl=_Constants2.default.manifest.logUrl;(0,_invariant2.default)(typeof logUrl==='string','The Expo project manifest must specify `logUrl`');_isSendingLogs=true;_context2.prev=6;_context2.next=9;return regeneratorRuntime.awrap(_sendNextLogBatchAsync(batch,logUrl));case 9:_context2.prev=9;_isSendingLogs=false;return _context2.finish(9);case 12:if(!_logQueue.length){_context2.next=16;break;}return _context2.abrupt('return',_sendRemoteLogsAsync());case 16:if(_resolveCompletion2){_resolveCompletion2();}case 17:case'end':return _context2.stop();}}},null,this,[[6,,9,12]]);}function _sendNextLogBatchAsync(batch,logUrl){var response,success;return regeneratorRuntime.async(function _sendNextLogBatchAsync$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:response=void 0;_context3.prev=1;_context3.next=4;return regeneratorRuntime.awrap(fetch(logUrl,{method:'POST',headers:{'Content-Type':'application/json',Connection:'keep-alive','Proxy-Connection':'keep-alive',Accept:'application/json','Device-Id':_Constants2.default.deviceId,'Device-Name':_Constants2.default.deviceName,'Session-Id':_sessionId},body:JSON.stringify(batch)}));case 4:response=_context3.sent;_context3.next=11;break;case 7:_context3.prev=7;_context3.t0=_context3['catch'](1);_transportEventEmitter.emit('error',{error:_context3.t0});return _context3.abrupt('return');case 11:success=response.status>=200&&response.status<300;if(!success){_transportEventEmitter.emit('error',{error:new Error('An HTTP error occurred when sending remote logs'),response:response});}case 13:case'end':return _context3.stop();}}},null,this,[[1,7]]);}function addTransportErrorListener(listener){return _transportEventEmitter.addListener('error',listener);}function _isReactNativeWarning(data){return data.length===1&&typeof data[0]==='string'&&data[0].startsWith('Warning: ');}exports.default={enqueueRemoteLogAsync:enqueueRemoteLogAsync,addTransportErrorListener:addTransportErrorListener};function __waitForEmptyLogQueueAsync(){if(_completionPromise){return _completionPromise;}if(!_isSendingLogs&&!_logQueue.length){return Promise.resolve();}_completionPromise=new Promise(function(resolve){_resolveCompletion2=function _resolveCompletion(){(0,_invariant2.default)(!_isSendingLogs,'Must not be sending logs at completion');(0,_invariant2.default)(!_logQueue.length,'Log queue must be empty at completion');_completionPromise=null;_resolveCompletion2=null;resolve();};});return _completionPromise;}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlbW90ZUxvZ2dpbmcuanMiXSwibmFtZXMiOlsiX193YWl0Rm9yRW1wdHlMb2dRdWV1ZUFzeW5jIiwiX3Nlc3Npb25JZCIsIlVVSUQiLCJjcmVhdGUiLCJ0b1N0cmluZyIsIl9sb2dRdWV1ZSIsIl90cmFuc3BvcnRFdmVudEVtaXR0ZXIiLCJFdmVudEVtaXR0ZXIiLCJfbG9nQ291bnRlciIsIl9pc1NlbmRpbmdMb2dzIiwiX2NvbXBsZXRpb25Qcm9taXNlIiwiX3Jlc29sdmVDb21wbGV0aW9uIiwiZW5xdWV1ZVJlbW90ZUxvZ0FzeW5jIiwibGV2ZWwiLCJhZGRpdGlvbmFsRmllbGRzIiwiZGF0YSIsIl9pc1JlYWN0TmF0aXZlV2FybmluZyIsImxlbmd0aCIsIndhcm5pbmciLCJsaW5lcyIsInNwbGl0IiwidGVzdCIsIkxvZ1NlcmlhbGl6YXRpb24iLCJzZXJpYWxpemVMb2dEYXRhQXN5bmMiLCJib2R5IiwiaW5jbHVkZXNTdGFjayIsInB1c2giLCJjb3VudCIsIl9zZW5kUmVtb3RlTG9nc0FzeW5jIiwiY2F0Y2giLCJzZXRJbW1lZGlhdGUiLCJlcnJvciIsImJhdGNoIiwic3BsaWNlIiwibG9nVXJsIiwiQ29uc3RhbnRzIiwibWFuaWZlc3QiLCJfc2VuZE5leHRMb2dCYXRjaEFzeW5jIiwicmVzcG9uc2UiLCJmZXRjaCIsIm1ldGhvZCIsImhlYWRlcnMiLCJDb25uZWN0aW9uIiwiQWNjZXB0IiwiZGV2aWNlSWQiLCJkZXZpY2VOYW1lIiwiSlNPTiIsInN0cmluZ2lmeSIsImVtaXQiLCJzdWNjZXNzIiwic3RhdHVzIiwiRXJyb3IiLCJhZGRUcmFuc3BvcnRFcnJvckxpc3RlbmVyIiwibGlzdGVuZXIiLCJhZGRMaXN0ZW5lciIsInN0YXJ0c1dpdGgiLCJQcm9taXNlIiwicmVzb2x2ZSJdLCJtYXBwaW5ncyI6ImlTQW1KZ0JBLDJCLENBQUFBLDJCLENBakpoQixvQ0FDQSxvQyxtREFDQSwrQiw2Q0FFQSxvRCxpRUFDQSx1QyxzSUFzQkEsR0FBTUMsWUFBYUMsaUJBQUtDLE1BQUwsR0FBY0MsUUFBZCxFQUFuQixDQUNBLEdBQU1DLFdBQTZCLEVBQW5DLENBQ0EsR0FBTUMsd0JBQXlCLEdBQUlDLHdCQUFKLEVBQS9CLENBRUEsR0FBSUMsYUFBYyxDQUFsQixDQUNBLEdBQUlDLGdCQUFpQixLQUFyQixDQUNBLEdBQUlDLDBCQUFKLENBQ0EsR0FBSUMsMkJBQUosQ0FFQSxRQUFlQyxzQkFBZixDQUNFQyxLQURGLENBRUVDLGdCQUZGLENBR0VDLElBSEYsMEtBS0UsR0FBSUMsc0JBQXNCRCxJQUF0QixDQUFKLENBQWlDLENBRS9CLHdCQUFVQSxLQUFLRSxNQUFMLENBQWMsQ0FBeEIsd0NBQ0Esd0JBQVUsTUFBT0YsTUFBSyxDQUFMLENBQVAsR0FBbUIsUUFBN0Isb0RBRU1HLE9BTHlCLENBS2ZILEtBQUssQ0FBTCxDQUxlLENBTXpCSSxLQU55QixDQU1qQkQsUUFBUUUsS0FBUixDQUFjLElBQWQsQ0FOaUIsQ0FPL0IsR0FBSUQsTUFBTUYsTUFBTixDQUFlLENBQWYsRUFBb0IsVUFBVUksSUFBVixDQUFlRixNQUFNLENBQU4sQ0FBZixDQUF4QixDQUFrRCxDQUNoREosS0FBSyxDQUFMLEVBQVVJLE1BQU0sQ0FBTixDQUFWLENBQ0QsQ0FDRixDQWZILGdEQWlCc0NHLDJCQUFpQkMscUJBQWpCLENBQXVDUixJQUF2QyxDQUE2Q0YsS0FBN0MsQ0FqQnRDLDRCQWlCUVcsSUFqQlIsTUFpQlFBLElBakJSLENBaUJjQyxhQWpCZCxNQWlCY0EsYUFqQmQsQ0FtQkVwQixVQUFVcUIsSUFBVixXQUNFQyxNQUFPbkIsYUFEVCxDQUVFSyxXQUZGLENBR0VXLFNBSEYsQ0FJRUMsMkJBSkYsRUFLS1gsZ0JBTEwsR0FTQWMsdUJBQXVCQyxLQUF2QixDQUE2QixlQUFTLENBQ3BDQyxhQUFhLFVBQU0sQ0FDakIsS0FBTUMsTUFBTixDQUNELENBRkQsRUFHRCxDQUpELEVBNUJGLHdEQW1DQSxRQUFlSCxxQkFBZix5SkFDTW5CLGdCQUFrQixDQUFDSixVQUFVWSxNQURuQyxvRUFPTWUsS0FQTixDQU9jM0IsVUFBVTRCLE1BQVYsQ0FBaUIsQ0FBakIsQ0FQZCxDQVNRQyxNQVRSLENBU21CQyxvQkFBVUMsUUFUN0IsQ0FTUUYsTUFUUixDQVVFLHdCQUFVLE1BQU9BLE9BQVAsR0FBa0IsUUFBNUIsQ0FBc0MsaURBQXRDLEVBRUF6QixlQUFpQixJQUFqQixDQVpGLGtFQWNVNEIsdUJBQXVCTCxLQUF2QixDQUE4QkUsTUFBOUIsQ0FkViwwQkFnQkl6QixlQUFpQixLQUFqQixDQWhCSix1Q0FtQk1KLFVBQVVZLE1BbkJoQiw0REFvQldXLHNCQXBCWCxVQXFCUyxHQUFJakIsbUJBQUosQ0FBd0IsQ0FDN0JBLHNCQUNELENBdkJILHNFQTBCQSxRQUFlMEIsdUJBQWYsQ0FBc0NMLEtBQXRDLENBQThERSxNQUE5RCx5SkFDTUksUUFETiwwRUFHcUJDLE1BQU1MLE1BQU4sQ0FBYyxDQUM3Qk0sT0FBUSxNQURxQixDQUU3QkMsUUFBUyxDQUNQLGVBQWdCLGtCQURULENBRVBDLFdBQVksWUFGTCxDQUdQLG1CQUFvQixZQUhiLENBSVBDLE9BQVEsa0JBSkQsQ0FLUCxZQUFhUixvQkFBVVMsUUFMaEIsQ0FNUCxjQUFlVCxvQkFBVVUsVUFObEIsQ0FPUCxhQUFjNUMsVUFQUCxDQUZvQixDQVc3QnVCLEtBQU1zQixLQUFLQyxTQUFMLENBQWVmLEtBQWYsQ0FYdUIsQ0FBZCxDQUhyQixTQUdJTSxRQUhKLG1HQWlCSWhDLHVCQUF1QjBDLElBQXZCLENBQTRCLE9BQTVCLENBQXFDLENBQUVqQixrQkFBRixDQUFyQyxFQWpCSiwwQ0FxQk1rQixPQXJCTixDQXFCZ0JYLFNBQVNZLE1BQVQsRUFBbUIsR0FBbkIsRUFBMEJaLFNBQVNZLE1BQVQsQ0FBa0IsR0FyQjVELENBc0JFLEdBQUksQ0FBQ0QsT0FBTCxDQUFjLENBQ1ozQyx1QkFBdUIwQyxJQUF2QixDQUE0QixPQUE1QixDQUFxQyxDQUNuQ2pCLE1BQU8sR0FBSW9CLE1BQUosbURBRDRCLENBRW5DYixpQkFGbUMsQ0FBckMsRUFJRCxDQTNCSCxrRUE4QkEsUUFBU2MsMEJBQVQsQ0FBbUNDLFFBQW5DLENBQXdGLENBQ3RGLE1BQU8vQyx3QkFBdUJnRCxXQUF2QixDQUFtQyxPQUFuQyxDQUE0Q0QsUUFBNUMsQ0FBUCxDQUNELENBRUQsUUFBU3JDLHNCQUFULENBQStCRCxJQUEvQixDQUE0RCxDQUUxRCxNQUFPQSxNQUFLRSxNQUFMLEdBQWdCLENBQWhCLEVBQXFCLE1BQU9GLE1BQUssQ0FBTCxDQUFQLEdBQW1CLFFBQXhDLEVBQW9EQSxLQUFLLENBQUwsRUFBUXdDLFVBQVIsQ0FBbUIsV0FBbkIsQ0FBM0QsQ0FDRCxDLGdCQUVjLENBQ2IzQywyQ0FEYSxDQUVid0MsbURBRmEsQyxDQVNSLFFBQVNwRCw0QkFBVCxFQUFzRCxDQUMzRCxHQUFJVSxrQkFBSixDQUF3QixDQUN0QixNQUFPQSxtQkFBUCxDQUNELENBRUQsR0FBSSxDQUFDRCxjQUFELEVBQW1CLENBQUNKLFVBQVVZLE1BQWxDLENBQTBDLENBQ3hDLE1BQU91QyxTQUFRQyxPQUFSLEVBQVAsQ0FDRCxDQUVEL0MsbUJBQXFCLEdBQUk4QyxRQUFKLENBQVksaUJBQVcsQ0FDMUM3QyxvQkFBcUIsNkJBQU0sQ0FDekIsd0JBQVUsQ0FBQ0YsY0FBWCwyQ0FDQSx3QkFBVSxDQUFDSixVQUFVWSxNQUFyQiwwQ0FFQVAsbUJBQXFCLElBQXJCLENBQ0FDLG9CQUFxQixJQUFyQixDQUVBOEMsVUFDRCxDQVJELENBU0QsQ0FWb0IsQ0FBckIsQ0FXQSxNQUFPL0MsbUJBQVAsQ0FDRCIsImZpbGUiOiJSZW1vdGVMb2dnaW5nLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCB0eXBlIEV2ZW50U3Vic2NyaXB0aW9uIH0gZnJvbSAnZmJlbWl0dGVyJztcbmltcG9ydCBpbnZhcmlhbnQgZnJvbSAnaW52YXJpYW50JztcbmltcG9ydCBVVUlEIGZyb20gJ3V1aWQtanMnO1xuXG5pbXBvcnQgTG9nU2VyaWFsaXphdGlvbiBmcm9tICcuL0xvZ1NlcmlhbGl6YXRpb24nO1xuaW1wb3J0IENvbnN0YW50cyBmcm9tICcuLi9Db25zdGFudHMnO1xuXG5leHBvcnQgdHlwZSBMb2dMZXZlbCA9ICdkZWJ1ZycgfCAnaW5mbycgfCAnd2FybicgfCAnZXJyb3InO1xuXG50eXBlIExvZ0VudHJ5ID0ge1xuICBjb3VudDogbnVtYmVyLFxuICBsZXZlbDogTG9nTGV2ZWwsXG4gIGJvZHk6IEFycmF5PExvZ0RhdGE+LFxuICBpbmNsdWRlc1N0YWNrOiBib29sZWFuLFxuICBncm91cERlcHRoPzogbnVtYmVyLFxufSAmIExvZ0VudHJ5RmllbGRzO1xuXG5leHBvcnQgdHlwZSBMb2dFbnRyeUZpZWxkcyA9IHtcbiAgc2hvdWxkSGlkZT86IGJvb2xlYW4sXG4gIGdyb3VwRGVwdGg/OiBudW1iZXIsXG4gIGdyb3VwQ29sbGFwc2VkPzogYm9vbGVhbixcbn07XG5cbmV4cG9ydCB0eXBlIExvZ0RhdGEgPSBzdHJpbmcgfCB7fCBtZXNzYWdlOiBzdHJpbmcsIHN0YWNrOiBzdHJpbmcgfH07XG5cbnR5cGUgVHJhbnNwb3J0RXJyb3JMaXN0ZW5lciA9ICh7IGVycm9yOiBFcnJvciwgcmVzcG9uc2U/OiBSZXNwb25zZSB9KSA9PiB2b2lkO1xuXG5jb25zdCBfc2Vzc2lvbklkID0gVVVJRC5jcmVhdGUoKS50b1N0cmluZygpO1xuY29uc3QgX2xvZ1F1ZXVlOiBBcnJheTxMb2dFbnRyeT4gPSBbXTtcbmNvbnN0IF90cmFuc3BvcnRFdmVudEVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbmxldCBfbG9nQ291bnRlciA9IDA7XG5sZXQgX2lzU2VuZGluZ0xvZ3MgPSBmYWxzZTtcbmxldCBfY29tcGxldGlvblByb21pc2U6ID9Qcm9taXNlPHZvaWQ+O1xubGV0IF9yZXNvbHZlQ29tcGxldGlvbjogPygpID0+IHZvaWQ7XG5cbmFzeW5jIGZ1bmN0aW9uIGVucXVldWVSZW1vdGVMb2dBc3luYyhcbiAgbGV2ZWw6IExvZ0xldmVsLFxuICBhZGRpdGlvbmFsRmllbGRzOiBMb2dFbnRyeUZpZWxkcyxcbiAgZGF0YTogQXJyYXk8bWl4ZWQ+XG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgaWYgKF9pc1JlYWN0TmF0aXZlV2FybmluZyhkYXRhKSkge1xuICAgIC8vIFJlbW92ZSB0aGUgc3RhY2sgdHJhY2UgZnJvbSB0aGUgd2FybmluZyBtZXNzYWdlIHNpbmNlIHdlJ2xsIGNhcHR1cmUgb3VyIG93blxuICAgIGludmFyaWFudChkYXRhLmxlbmd0aCA+IDAsIGBXYXJuaW5ncyBtdXN0IGluY2x1ZGUgbG9nIGFyZ3VtZW50c2ApO1xuICAgIGludmFyaWFudCh0eXBlb2YgZGF0YVswXSA9PT0gJ3N0cmluZycsIGBUaGUgbG9nIGFyZ3VtZW50IGZvciBhIHdhcm5pbmcgbXVzdCBiZSBhIHN0cmluZ2ApO1xuXG4gICAgY29uc3Qgd2FybmluZyA9IGRhdGFbMF07XG4gICAgY29uc3QgbGluZXMgPSB3YXJuaW5nLnNwbGl0KCdcXG4nKTtcbiAgICBpZiAobGluZXMubGVuZ3RoID4gMSAmJiAvXlxccytpbiAvLnRlc3QobGluZXNbMV0pKSB7XG4gICAgICBkYXRhWzBdID0gbGluZXNbMF07XG4gICAgfVxuICB9XG5cbiAgbGV0IHsgYm9keSwgaW5jbHVkZXNTdGFjayB9ID0gYXdhaXQgTG9nU2VyaWFsaXphdGlvbi5zZXJpYWxpemVMb2dEYXRhQXN5bmMoZGF0YSwgbGV2ZWwpO1xuXG4gIF9sb2dRdWV1ZS5wdXNoKHtcbiAgICBjb3VudDogX2xvZ0NvdW50ZXIrKyxcbiAgICBsZXZlbCxcbiAgICBib2R5LFxuICAgIGluY2x1ZGVzU3RhY2ssXG4gICAgLi4uYWRkaXRpb25hbEZpZWxkcyxcbiAgfSk7XG5cbiAgLy8gU2VuZCB0aGUgbG9ncyBhc3luY2hyb25vdXNseSAoc3lzdGVtIGVycm9ycyBhcmUgZW1pdHRlZCB3aXRoIHRyYW5zcG9ydCBlcnJvciBldmVudHMpIGFuZCB0aHJvdyBhbiB1bmNhdWdodCBlcnJvclxuICBfc2VuZFJlbW90ZUxvZ3NBc3luYygpLmNhdGNoKGVycm9yID0+IHtcbiAgICBzZXRJbW1lZGlhdGUoKCkgPT4ge1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBfc2VuZFJlbW90ZUxvZ3NBc3luYygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgaWYgKF9pc1NlbmRpbmdMb2dzIHx8ICFfbG9nUXVldWUubGVuZ3RoKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gT3VyIGN1cnJlbnQgdHJhbnNwb3J0IHBvbGljeSBpcyB0byBzZW5kIGFsbCBvZiB0aGUgcGVuZGluZyBsb2cgbWVzc2FnZXMgaW4gb25lIGJhdGNoLiBJZiB3ZSBvcHRcbiAgLy8gZm9yIGFub3RoZXIgcG9saWN5IChleDogdGhyb3R0bGluZykgdGhpcyBpcyB3aGVyZSB0byB0byBpbXBsZW1lbnQgaXQuXG4gIGxldCBiYXRjaCA9IF9sb2dRdWV1ZS5zcGxpY2UoMCk7XG5cbiAgbGV0IHsgbG9nVXJsIH0gPSBDb25zdGFudHMubWFuaWZlc3Q7XG4gIGludmFyaWFudCh0eXBlb2YgbG9nVXJsID09PSAnc3RyaW5nJywgJ1RoZSBFeHBvIHByb2plY3QgbWFuaWZlc3QgbXVzdCBzcGVjaWZ5IGBsb2dVcmxgJyk7XG5cbiAgX2lzU2VuZGluZ0xvZ3MgPSB0cnVlO1xuICB0cnkge1xuICAgIGF3YWl0IF9zZW5kTmV4dExvZ0JhdGNoQXN5bmMoYmF0Y2gsIGxvZ1VybCk7XG4gIH0gZmluYWxseSB7XG4gICAgX2lzU2VuZGluZ0xvZ3MgPSBmYWxzZTtcbiAgfVxuXG4gIGlmIChfbG9nUXVldWUubGVuZ3RoKSB7XG4gICAgcmV0dXJuIF9zZW5kUmVtb3RlTG9nc0FzeW5jKCk7XG4gIH0gZWxzZSBpZiAoX3Jlc29sdmVDb21wbGV0aW9uKSB7XG4gICAgX3Jlc29sdmVDb21wbGV0aW9uKCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gX3NlbmROZXh0TG9nQmF0Y2hBc3luYyhiYXRjaDogQXJyYXk8TG9nRW50cnk+LCBsb2dVcmw6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBsZXQgcmVzcG9uc2U7XG4gIHRyeSB7XG4gICAgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChsb2dVcmwsIHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICBDb25uZWN0aW9uOiAna2VlcC1hbGl2ZScsXG4gICAgICAgICdQcm94eS1Db25uZWN0aW9uJzogJ2tlZXAtYWxpdmUnLFxuICAgICAgICBBY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0RldmljZS1JZCc6IENvbnN0YW50cy5kZXZpY2VJZCxcbiAgICAgICAgJ0RldmljZS1OYW1lJzogQ29uc3RhbnRzLmRldmljZU5hbWUsXG4gICAgICAgICdTZXNzaW9uLUlkJzogX3Nlc3Npb25JZCxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShiYXRjaCksXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgX3RyYW5zcG9ydEV2ZW50RW1pdHRlci5lbWl0KCdlcnJvcicsIHsgZXJyb3IgfSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IHN1Y2Nlc3MgPSByZXNwb25zZS5zdGF0dXMgPj0gMjAwICYmIHJlc3BvbnNlLnN0YXR1cyA8IDMwMDtcbiAgaWYgKCFzdWNjZXNzKSB7XG4gICAgX3RyYW5zcG9ydEV2ZW50RW1pdHRlci5lbWl0KCdlcnJvcicsIHtcbiAgICAgIGVycm9yOiBuZXcgRXJyb3IoYEFuIEhUVFAgZXJyb3Igb2NjdXJyZWQgd2hlbiBzZW5kaW5nIHJlbW90ZSBsb2dzYCksXG4gICAgICByZXNwb25zZSxcbiAgICB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhZGRUcmFuc3BvcnRFcnJvckxpc3RlbmVyKGxpc3RlbmVyOiBUcmFuc3BvcnRFcnJvckxpc3RlbmVyKTogRXZlbnRTdWJzY3JpcHRpb24ge1xuICByZXR1cm4gX3RyYW5zcG9ydEV2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignZXJyb3InLCBsaXN0ZW5lcik7XG59XG5cbmZ1bmN0aW9uIF9pc1JlYWN0TmF0aXZlV2FybmluZyhkYXRhOiBBcnJheTxtaXhlZD4pOiBib29sZWFuIHtcbiAgLy8gTk9URTogUk4gZG9lcyB0aGUgc2FtZSB0aGluZyBpbnRlcm5hbGx5IGZvciBZZWxsb3dCb3hcbiAgcmV0dXJuIGRhdGEubGVuZ3RoID09PSAxICYmIHR5cGVvZiBkYXRhWzBdID09PSAnc3RyaW5nJyAmJiBkYXRhWzBdLnN0YXJ0c1dpdGgoJ1dhcm5pbmc6ICcpO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGVucXVldWVSZW1vdGVMb2dBc3luYyxcbiAgYWRkVHJhbnNwb3J0RXJyb3JMaXN0ZW5lcixcbn07XG5cbi8qKlxuICogUmV0dXJucyBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB3aGVuIGFsbCBlbnRyaWVzIGluIHRoZSBsb2cgcXVldWUgaGF2ZSBiZWVuIHNlbnQuIFRoaXMgbWV0aG9kIGlzXG4gKiBpbnRlbmRlZCBmb3IgdGVzdGluZyBvbmx5LlxuICovXG5leHBvcnQgZnVuY3Rpb24gX193YWl0Rm9yRW1wdHlMb2dRdWV1ZUFzeW5jKCk6IFByb21pc2U8dm9pZD4ge1xuICBpZiAoX2NvbXBsZXRpb25Qcm9taXNlKSB7XG4gICAgcmV0dXJuIF9jb21wbGV0aW9uUHJvbWlzZTtcbiAgfVxuXG4gIGlmICghX2lzU2VuZGluZ0xvZ3MgJiYgIV9sb2dRdWV1ZS5sZW5ndGgpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cblxuICBfY29tcGxldGlvblByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICBfcmVzb2x2ZUNvbXBsZXRpb24gPSAoKSA9PiB7XG4gICAgICBpbnZhcmlhbnQoIV9pc1NlbmRpbmdMb2dzLCBgTXVzdCBub3QgYmUgc2VuZGluZyBsb2dzIGF0IGNvbXBsZXRpb25gKTtcbiAgICAgIGludmFyaWFudCghX2xvZ1F1ZXVlLmxlbmd0aCwgYExvZyBxdWV1ZSBtdXN0IGJlIGVtcHR5IGF0IGNvbXBsZXRpb25gKTtcblxuICAgICAgX2NvbXBsZXRpb25Qcm9taXNlID0gbnVsbDtcbiAgICAgIF9yZXNvbHZlQ29tcGxldGlvbiA9IG51bGw7XG5cbiAgICAgIHJlc29sdmUoKTtcbiAgICB9O1xuICB9KTtcbiAgcmV0dXJuIF9jb21wbGV0aW9uUHJvbWlzZTtcbn1cbiJdfQ==