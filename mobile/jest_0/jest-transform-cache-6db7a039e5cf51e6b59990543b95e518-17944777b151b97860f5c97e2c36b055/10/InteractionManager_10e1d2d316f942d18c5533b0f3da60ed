cd0f709ceac0323f2a4098d592b3b1ae
'use strict';var BatchedBridge=require('BatchedBridge');var EventEmitter=require('EventEmitter');var Set=require('Set');var TaskQueue=require('TaskQueue');var infoLog=require('infoLog');var invariant=require('fbjs/lib/invariant');var keyMirror=require('fbjs/lib/keyMirror');var _emitter=new EventEmitter();var DEBUG_DELAY=0;var DEBUG=false;var InteractionManager={Events:keyMirror({interactionStart:true,interactionComplete:true}),runAfterInteractions:function runAfterInteractions(task){var tasks=[];var promise=new Promise(function(resolve){_scheduleUpdate();if(task){tasks.push(task);}tasks.push({run:resolve,name:'resolve '+(task&&task.name||'?')});_taskQueue.enqueueTasks(tasks);});return{then:promise.then.bind(promise),done:function done(){if(promise.done){return promise.done.apply(promise,arguments);}else{console.warn('Tried to call done when not supported by current Promise implementation.');}},cancel:function cancel(){_taskQueue.cancelTasks(tasks);}};},createInteractionHandle:function createInteractionHandle(){DEBUG&&infoLog('create interaction handle');_scheduleUpdate();var handle=++_inc;_addInteractionSet.add(handle);return handle;},clearInteractionHandle:function clearInteractionHandle(handle){DEBUG&&infoLog('clear interaction handle');invariant(!!handle,'Must provide a handle to clear.');_scheduleUpdate();_addInteractionSet.delete(handle);_deleteInteractionSet.add(handle);},addListener:_emitter.addListener.bind(_emitter),setDeadline:function setDeadline(deadline){_deadline=deadline;}};var _interactionSet=new Set();var _addInteractionSet=new Set();var _deleteInteractionSet=new Set();var _taskQueue=new TaskQueue({onMoreTasks:_scheduleUpdate});var _nextUpdateHandle=0;var _inc=0;var _deadline=-1;function _scheduleUpdate(){if(!_nextUpdateHandle){if(_deadline>0){_nextUpdateHandle=setTimeout(_processUpdate,0+DEBUG_DELAY);}else{_nextUpdateHandle=setImmediate(_processUpdate);}}}function _processUpdate(){_nextUpdateHandle=0;var interactionCount=_interactionSet.size;_addInteractionSet.forEach(function(handle){return _interactionSet.add(handle);});_deleteInteractionSet.forEach(function(handle){return _interactionSet.delete(handle);});var nextInteractionCount=_interactionSet.size;if(interactionCount!==0&&nextInteractionCount===0){_emitter.emit(InteractionManager.Events.interactionComplete);}else if(interactionCount===0&&nextInteractionCount!==0){_emitter.emit(InteractionManager.Events.interactionStart);}if(nextInteractionCount===0){while(_taskQueue.hasTasksToProcess()){_taskQueue.processNext();if(_deadline>0&&BatchedBridge.getEventLoopRunningTime()>=_deadline){_scheduleUpdate();break;}}}_addInteractionSet.clear();_deleteInteractionSet.clear();}module.exports=InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkludGVyYWN0aW9uTWFuYWdlci5qcyJdLCJuYW1lcyI6WyJCYXRjaGVkQnJpZGdlIiwicmVxdWlyZSIsIkV2ZW50RW1pdHRlciIsIlNldCIsIlRhc2tRdWV1ZSIsImluZm9Mb2ciLCJpbnZhcmlhbnQiLCJrZXlNaXJyb3IiLCJfZW1pdHRlciIsIkRFQlVHX0RFTEFZIiwiREVCVUciLCJJbnRlcmFjdGlvbk1hbmFnZXIiLCJFdmVudHMiLCJpbnRlcmFjdGlvblN0YXJ0IiwiaW50ZXJhY3Rpb25Db21wbGV0ZSIsInJ1bkFmdGVySW50ZXJhY3Rpb25zIiwidGFzayIsInRhc2tzIiwicHJvbWlzZSIsIlByb21pc2UiLCJfc2NoZWR1bGVVcGRhdGUiLCJwdXNoIiwicnVuIiwicmVzb2x2ZSIsIm5hbWUiLCJfdGFza1F1ZXVlIiwiZW5xdWV1ZVRhc2tzIiwidGhlbiIsImJpbmQiLCJkb25lIiwiY29uc29sZSIsIndhcm4iLCJjYW5jZWwiLCJjYW5jZWxUYXNrcyIsImNyZWF0ZUludGVyYWN0aW9uSGFuZGxlIiwiaGFuZGxlIiwiX2luYyIsIl9hZGRJbnRlcmFjdGlvblNldCIsImFkZCIsImNsZWFySW50ZXJhY3Rpb25IYW5kbGUiLCJkZWxldGUiLCJfZGVsZXRlSW50ZXJhY3Rpb25TZXQiLCJhZGRMaXN0ZW5lciIsInNldERlYWRsaW5lIiwiZGVhZGxpbmUiLCJfZGVhZGxpbmUiLCJfaW50ZXJhY3Rpb25TZXQiLCJvbk1vcmVUYXNrcyIsIl9uZXh0VXBkYXRlSGFuZGxlIiwic2V0VGltZW91dCIsIl9wcm9jZXNzVXBkYXRlIiwic2V0SW1tZWRpYXRlIiwiaW50ZXJhY3Rpb25Db3VudCIsInNpemUiLCJmb3JFYWNoIiwibmV4dEludGVyYWN0aW9uQ291bnQiLCJlbWl0IiwiaGFzVGFza3NUb1Byb2Nlc3MiLCJwcm9jZXNzTmV4dCIsImdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lIiwiY2xlYXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFTQSxhQUVB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QkcsYUFBYUQsY0FBYixDQUFwQixDQUNELENBQ0YsQ0FDRixDQUtELFFBQVNBLGVBQVQsRUFBMEIsQ0FDeEJGLGtCQUFvQixDQUFwQixDQUVBLEdBQUlJLGtCQUFtQk4sZ0JBQWdCTyxJQUF2QyxDQUNBaEIsbUJBQW1CaUIsT0FBbkIsQ0FBMkIsdUJBQ3pCUixpQkFBZ0JSLEdBQWhCLENBQW9CSCxNQUFwQixDQUR5QixFQUEzQixFQUdBTSxzQkFBc0JhLE9BQXRCLENBQThCLHVCQUM1QlIsaUJBQWdCTixNQUFoQixDQUF1QkwsTUFBdkIsQ0FENEIsRUFBOUIsRUFHQSxHQUFJb0Isc0JBQXVCVCxnQkFBZ0JPLElBQTNDLENBRUEsR0FBSUQsbUJBQXFCLENBQXJCLEVBQTBCRyx1QkFBeUIsQ0FBdkQsQ0FBMEQsQ0FFeEQvQyxTQUFTZ0QsSUFBVCxDQUFjN0MsbUJBQW1CQyxNQUFuQixDQUEwQkUsbUJBQXhDLEVBQ0QsQ0FIRCxJQUdPLElBQUlzQyxtQkFBcUIsQ0FBckIsRUFBMEJHLHVCQUF5QixDQUF2RCxDQUEwRCxDQUUvRC9DLFNBQVNnRCxJQUFULENBQWM3QyxtQkFBbUJDLE1BQW5CLENBQTBCQyxnQkFBeEMsRUFDRCxDQUdELEdBQUkwQyx1QkFBeUIsQ0FBN0IsQ0FBZ0MsQ0FDOUIsTUFBTzlCLFdBQVdnQyxpQkFBWCxFQUFQLENBQXVDLENBQ3JDaEMsV0FBV2lDLFdBQVgsR0FDQSxHQUFJYixVQUFZLENBQVosRUFDQTdDLGNBQWMyRCx1QkFBZCxJQUEyQ2QsU0FEL0MsQ0FDMEQsQ0FFeER6QixrQkFDQSxNQUNELENBQ0YsQ0FDRixDQUNEaUIsbUJBQW1CdUIsS0FBbkIsR0FDQW5CLHNCQUFzQm1CLEtBQXRCLEdBQ0QsQ0FFREMsT0FBT0MsT0FBUCxDQUFpQm5ELGtCQUFqQiIsImZpbGUiOiJJbnRlcmFjdGlvbk1hbmFnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBwcm92aWRlc01vZHVsZSBJbnRlcmFjdGlvbk1hbmFnZXJcbiAqIEBmbG93XG4gKi9cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgQmF0Y2hlZEJyaWRnZSA9IHJlcXVpcmUoJ0JhdGNoZWRCcmlkZ2UnKTtcbmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ0V2ZW50RW1pdHRlcicpO1xuY29uc3QgU2V0ID0gcmVxdWlyZSgnU2V0Jyk7XG5jb25zdCBUYXNrUXVldWUgPSByZXF1aXJlKCdUYXNrUXVldWUnKTtcblxuY29uc3QgaW5mb0xvZyA9IHJlcXVpcmUoJ2luZm9Mb2cnKTtcbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2ZianMvbGliL2ludmFyaWFudCcpO1xuLyogJEZsb3dGaXhNZSg+PTAuNTQuMCBzaXRlPXJlYWN0X25hdGl2ZV9vc3MpIFRoaXMgY29tbWVudCBzdXBwcmVzc2VzIGFuIGVycm9yXG4gKiBmb3VuZCB3aGVuIEZsb3cgdjAuNTQgd2FzIGRlcGxveWVkLiBUbyBzZWUgdGhlIGVycm9yIGRlbGV0ZSB0aGlzIGNvbW1lbnQgYW5kXG4gKiBydW4gRmxvdy4gKi9cbmNvbnN0IGtleU1pcnJvciA9IHJlcXVpcmUoJ2ZianMvbGliL2tleU1pcnJvcicpO1xuXG50eXBlIEhhbmRsZSA9IG51bWJlcjtcbmltcG9ydCB0eXBlIHtUYXNrfSBmcm9tICdUYXNrUXVldWUnO1xuXG5jb25zdCBfZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuY29uc3QgREVCVUdfREVMQVkgPSAwO1xuY29uc3QgREVCVUcgPSBmYWxzZTtcblxuLyoqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxsb3dzIGxvbmctcnVubmluZyB3b3JrIHRvIGJlIHNjaGVkdWxlZCBhZnRlciBhbnlcbiAqIGludGVyYWN0aW9ucy9hbmltYXRpb25zIGhhdmUgY29tcGxldGVkLiBJbiBwYXJ0aWN1bGFyLCB0aGlzIGFsbG93cyBKYXZhU2NyaXB0XG4gKiBhbmltYXRpb25zIHRvIHJ1biBzbW9vdGhseS5cbiAqXG4gKiBBcHBsaWNhdGlvbnMgY2FuIHNjaGVkdWxlIHRhc2tzIHRvIHJ1biBhZnRlciBpbnRlcmFjdGlvbnMgd2l0aCB0aGUgZm9sbG93aW5nOlxuICpcbiAqIGBgYFxuICogSW50ZXJhY3Rpb25NYW5hZ2VyLnJ1bkFmdGVySW50ZXJhY3Rpb25zKCgpID0+IHtcbiAqICAgLy8gLi4ubG9uZy1ydW5uaW5nIHN5bmNocm9ub3VzIHRhc2suLi5cbiAqIH0pO1xuICogYGBgXG4gKlxuICogQ29tcGFyZSB0aGlzIHRvIG90aGVyIHNjaGVkdWxpbmcgYWx0ZXJuYXRpdmVzOlxuICpcbiAqIC0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk6IGZvciBjb2RlIHRoYXQgYW5pbWF0ZXMgYSB2aWV3IG92ZXIgdGltZS5cbiAqIC0gc2V0SW1tZWRpYXRlL3NldFRpbWVvdXQoKTogcnVuIGNvZGUgbGF0ZXIsIG5vdGUgdGhpcyBtYXkgZGVsYXkgYW5pbWF0aW9ucy5cbiAqIC0gcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKTogcnVuIGNvZGUgbGF0ZXIsIHdpdGhvdXQgZGVsYXlpbmcgYWN0aXZlIGFuaW1hdGlvbnMuXG4gKlxuICogVGhlIHRvdWNoIGhhbmRsaW5nIHN5c3RlbSBjb25zaWRlcnMgb25lIG9yIG1vcmUgYWN0aXZlIHRvdWNoZXMgdG8gYmUgYW5cbiAqICdpbnRlcmFjdGlvbicgYW5kIHdpbGwgZGVsYXkgYHJ1bkFmdGVySW50ZXJhY3Rpb25zKClgIGNhbGxiYWNrcyB1bnRpbCBhbGxcbiAqIHRvdWNoZXMgaGF2ZSBlbmRlZCBvciBiZWVuIGNhbmNlbGxlZC5cbiAqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxzbyBhbGxvd3MgYXBwbGljYXRpb25zIHRvIHJlZ2lzdGVyIGFuaW1hdGlvbnMgYnlcbiAqIGNyZWF0aW5nIGFuIGludGVyYWN0aW9uICdoYW5kbGUnIG9uIGFuaW1hdGlvbiBzdGFydCwgYW5kIGNsZWFyaW5nIGl0IHVwb25cbiAqIGNvbXBsZXRpb246XG4gKlxuICogYGBgXG4gKiB2YXIgaGFuZGxlID0gSW50ZXJhY3Rpb25NYW5hZ2VyLmNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCk7XG4gKiAvLyBydW4gYW5pbWF0aW9uLi4uIChgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgIHRhc2tzIGFyZSBxdWV1ZWQpXG4gKiAvLyBsYXRlciwgb24gYW5pbWF0aW9uIGNvbXBsZXRpb246XG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIuY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShoYW5kbGUpO1xuICogLy8gcXVldWVkIHRhc2tzIHJ1biBpZiBhbGwgaGFuZGxlcyB3ZXJlIGNsZWFyZWRcbiAqIGBgYFxuICpcbiAqIGBydW5BZnRlckludGVyYWN0aW9uc2AgdGFrZXMgZWl0aGVyIGEgcGxhaW4gY2FsbGJhY2sgZnVuY3Rpb24sIG9yIGFcbiAqIGBQcm9taXNlVGFza2Agb2JqZWN0IHdpdGggYSBgZ2VuYCBtZXRob2QgdGhhdCByZXR1cm5zIGEgYFByb21pc2VgLiAgSWYgYVxuICogYFByb21pc2VUYXNrYCBpcyBzdXBwbGllZCwgdGhlbiBpdCBpcyBmdWxseSByZXNvbHZlZCAoaW5jbHVkaW5nIGFzeW5jaHJvbm91c1xuICogZGVwZW5kZW5jaWVzIHRoYXQgYWxzbyBzY2hlZHVsZSBtb3JlIHRhc2tzIHZpYSBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgKSBiZWZvcmVcbiAqIHN0YXJ0aW5nIG9uIHRoZSBuZXh0IHRhc2sgdGhhdCBtaWdodCBoYXZlIGJlZW4gcXVldWVkIHVwIHN5bmNocm9ub3VzbHlcbiAqIGVhcmxpZXIuXG4gKlxuICogQnkgZGVmYXVsdCwgcXVldWVkIHRhc2tzIGFyZSBleGVjdXRlZCB0b2dldGhlciBpbiBhIGxvb3AgaW4gb25lXG4gKiBgc2V0SW1tZWRpYXRlYCBiYXRjaC4gSWYgYHNldERlYWRsaW5lYCBpcyBjYWxsZWQgd2l0aCBhIHBvc2l0aXZlIG51bWJlciwgdGhlblxuICogdGFza3Mgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIHVudGlsIHRoZSBkZWFkbGluZSAoaW4gdGVybXMgb2YganMgZXZlbnQgbG9vcCBydW5cbiAqIHRpbWUpIGFwcHJvYWNoZXMsIGF0IHdoaWNoIHBvaW50IGV4ZWN1dGlvbiB3aWxsIHlpZWxkIHZpYSBzZXRUaW1lb3V0LFxuICogYWxsb3dpbmcgZXZlbnRzIHN1Y2ggYXMgdG91Y2hlcyB0byBzdGFydCBpbnRlcmFjdGlvbnMgYW5kIGJsb2NrIHF1ZXVlZCB0YXNrc1xuICogZnJvbSBleGVjdXRpbmcsIG1ha2luZyBhcHBzIG1vcmUgcmVzcG9uc2l2ZS5cbiAqL1xudmFyIEludGVyYWN0aW9uTWFuYWdlciA9IHtcbiAgRXZlbnRzOiBrZXlNaXJyb3Ioe1xuICAgIGludGVyYWN0aW9uU3RhcnQ6IHRydWUsXG4gICAgaW50ZXJhY3Rpb25Db21wbGV0ZTogdHJ1ZSxcbiAgfSksXG5cbiAgLyoqXG4gICAqIFNjaGVkdWxlIGEgZnVuY3Rpb24gdG8gcnVuIGFmdGVyIGFsbCBpbnRlcmFjdGlvbnMgaGF2ZSBjb21wbGV0ZWQuIFJldHVybnMgYSBjYW5jZWxsYWJsZVxuICAgKiBcInByb21pc2VcIi5cbiAgICovXG4gIHJ1bkFmdGVySW50ZXJhY3Rpb25zKHRhc2s6ID9UYXNrKToge3RoZW46IEZ1bmN0aW9uLCBkb25lOiBGdW5jdGlvbiwgY2FuY2VsOiBGdW5jdGlvbn0ge1xuICAgIGNvbnN0IHRhc2tzID0gW107XG4gICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgICBpZiAodGFzaykge1xuICAgICAgICB0YXNrcy5wdXNoKHRhc2spO1xuICAgICAgfVxuICAgICAgdGFza3MucHVzaCh7cnVuOiByZXNvbHZlLCBuYW1lOiAncmVzb2x2ZSAnICsgKHRhc2sgJiYgdGFzay5uYW1lIHx8ICc/Jyl9KTtcbiAgICAgIF90YXNrUXVldWUuZW5xdWV1ZVRhc2tzKHRhc2tzKTtcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgdGhlbjogcHJvbWlzZS50aGVuLmJpbmQocHJvbWlzZSksXG4gICAgICBkb25lOiAoLi4uYXJncykgPT4ge1xuICAgICAgICBpZiAocHJvbWlzZS5kb25lKSB7XG4gICAgICAgICAgcmV0dXJuIHByb21pc2UuZG9uZSguLi5hcmdzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oJ1RyaWVkIHRvIGNhbGwgZG9uZSB3aGVuIG5vdCBzdXBwb3J0ZWQgYnkgY3VycmVudCBQcm9taXNlIGltcGxlbWVudGF0aW9uLicpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgY2FuY2VsOiBmdW5jdGlvbigpIHtcbiAgICAgICAgX3Rhc2tRdWV1ZS5jYW5jZWxUYXNrcyh0YXNrcyk7XG4gICAgICB9LFxuICAgIH07XG4gIH0sXG5cbiAgLyoqXG4gICAqIE5vdGlmeSBtYW5hZ2VyIHRoYXQgYW4gaW50ZXJhY3Rpb24gaGFzIHN0YXJ0ZWQuXG4gICAqL1xuICBjcmVhdGVJbnRlcmFjdGlvbkhhbmRsZSgpOiBIYW5kbGUge1xuICAgIERFQlVHICYmIGluZm9Mb2coJ2NyZWF0ZSBpbnRlcmFjdGlvbiBoYW5kbGUnKTtcbiAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICB2YXIgaGFuZGxlID0gKytfaW5jO1xuICAgIF9hZGRJbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKTtcbiAgICByZXR1cm4gaGFuZGxlO1xuICB9LFxuXG4gIC8qKlxuICAgKiBOb3RpZnkgbWFuYWdlciB0aGF0IGFuIGludGVyYWN0aW9uIGhhcyBjb21wbGV0ZWQuXG4gICAqL1xuICBjbGVhckludGVyYWN0aW9uSGFuZGxlKGhhbmRsZTogSGFuZGxlKSB7XG4gICAgREVCVUcgJiYgaW5mb0xvZygnY2xlYXIgaW50ZXJhY3Rpb24gaGFuZGxlJyk7XG4gICAgaW52YXJpYW50KFxuICAgICAgISFoYW5kbGUsXG4gICAgICAnTXVzdCBwcm92aWRlIGEgaGFuZGxlIHRvIGNsZWFyLidcbiAgICApO1xuICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgIF9hZGRJbnRlcmFjdGlvblNldC5kZWxldGUoaGFuZGxlKTtcbiAgICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSk7XG4gIH0sXG5cbiAgYWRkTGlzdGVuZXI6IF9lbWl0dGVyLmFkZExpc3RlbmVyLmJpbmQoX2VtaXR0ZXIpLFxuXG4gIC8qKlxuICAgKiBBIHBvc2l0aXZlIG51bWJlciB3aWxsIHVzZSBzZXRUaW1lb3V0IHRvIHNjaGVkdWxlIGFueSB0YXNrcyBhZnRlciB0aGVcbiAgICogZXZlbnRMb29wUnVubmluZ1RpbWUgaGl0cyB0aGUgZGVhZGxpbmUgdmFsdWUsIG90aGVyd2lzZSBhbGwgdGFza3Mgd2lsbCBiZVxuICAgKiBleGVjdXRlZCBpbiBvbmUgc2V0SW1tZWRpYXRlIGJhdGNoIChkZWZhdWx0KS5cbiAgICovXG4gIHNldERlYWRsaW5lKGRlYWRsaW5lOiBudW1iZXIpIHtcbiAgICBfZGVhZGxpbmUgPSBkZWFkbGluZTtcbiAgfSxcbn07XG5cbmNvbnN0IF9pbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF9hZGRJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF9kZWxldGVJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF90YXNrUXVldWUgPSBuZXcgVGFza1F1ZXVlKHtvbk1vcmVUYXNrczogX3NjaGVkdWxlVXBkYXRlfSk7XG5sZXQgX25leHRVcGRhdGVIYW5kbGUgPSAwO1xubGV0IF9pbmMgPSAwO1xubGV0IF9kZWFkbGluZSA9IC0xO1xuXG5kZWNsYXJlIGZ1bmN0aW9uIHNldEltbWVkaWF0ZShjYWxsYmFjazogYW55LCAuLi5hcmdzOiBBcnJheTxhbnk+KTogbnVtYmVyO1xuXG4vKipcbiAqIFNjaGVkdWxlIGFuIGFzeW5jaHJvbm91cyB1cGRhdGUgdG8gdGhlIGludGVyYWN0aW9uIHN0YXRlLlxuICovXG5mdW5jdGlvbiBfc2NoZWR1bGVVcGRhdGUoKSB7XG4gIGlmICghX25leHRVcGRhdGVIYW5kbGUpIHtcbiAgICBpZiAoX2RlYWRsaW5lID4gMCkge1xuICAgICAgLyogJEZsb3dGaXhNZSg+PTAuNjMuMCBzaXRlPXJlYWN0X25hdGl2ZV9mYikgVGhpcyBjb21tZW50IHN1cHByZXNzZXMgYW5cbiAgICAgICAqIGVycm9yIGZvdW5kIHdoZW4gRmxvdyB2MC42MyB3YXMgZGVwbG95ZWQuIFRvIHNlZSB0aGUgZXJyb3IgZGVsZXRlIHRoaXNcbiAgICAgICAqIGNvbW1lbnQgYW5kIHJ1biBGbG93LiAqL1xuICAgICAgX25leHRVcGRhdGVIYW5kbGUgPSBzZXRUaW1lb3V0KF9wcm9jZXNzVXBkYXRlLCAwICsgREVCVUdfREVMQVkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBfbmV4dFVwZGF0ZUhhbmRsZSA9IHNldEltbWVkaWF0ZShfcHJvY2Vzc1VwZGF0ZSk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogTm90aWZ5IGxpc3RlbmVycywgcHJvY2VzcyBxdWV1ZSwgZXRjXG4gKi9cbmZ1bmN0aW9uIF9wcm9jZXNzVXBkYXRlKCkge1xuICBfbmV4dFVwZGF0ZUhhbmRsZSA9IDA7XG5cbiAgdmFyIGludGVyYWN0aW9uQ291bnQgPSBfaW50ZXJhY3Rpb25TZXQuc2l6ZTtcbiAgX2FkZEludGVyYWN0aW9uU2V0LmZvckVhY2goaGFuZGxlID0+XG4gICAgX2ludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpXG4gICk7XG4gIF9kZWxldGVJbnRlcmFjdGlvblNldC5mb3JFYWNoKGhhbmRsZSA9PlxuICAgIF9pbnRlcmFjdGlvblNldC5kZWxldGUoaGFuZGxlKVxuICApO1xuICB2YXIgbmV4dEludGVyYWN0aW9uQ291bnQgPSBfaW50ZXJhY3Rpb25TZXQuc2l6ZTtcblxuICBpZiAoaW50ZXJhY3Rpb25Db3VudCAhPT0gMCAmJiBuZXh0SW50ZXJhY3Rpb25Db3VudCA9PT0gMCkge1xuICAgIC8vIHRyYW5zaXRpb24gZnJvbSAxKyAtLT4gMCBpbnRlcmFjdGlvbnNcbiAgICBfZW1pdHRlci5lbWl0KEludGVyYWN0aW9uTWFuYWdlci5FdmVudHMuaW50ZXJhY3Rpb25Db21wbGV0ZSk7XG4gIH0gZWxzZSBpZiAoaW50ZXJhY3Rpb25Db3VudCA9PT0gMCAmJiBuZXh0SW50ZXJhY3Rpb25Db3VudCAhPT0gMCkge1xuICAgIC8vIHRyYW5zaXRpb24gZnJvbSAwIC0tPiAxKyBpbnRlcmFjdGlvbnNcbiAgICBfZW1pdHRlci5lbWl0KEludGVyYWN0aW9uTWFuYWdlci5FdmVudHMuaW50ZXJhY3Rpb25TdGFydCk7XG4gIH1cblxuICAvLyBwcm9jZXNzIHRoZSBxdWV1ZSByZWdhcmRsZXNzIG9mIGEgdHJhbnNpdGlvblxuICBpZiAobmV4dEludGVyYWN0aW9uQ291bnQgPT09IDApIHtcbiAgICB3aGlsZSAoX3Rhc2tRdWV1ZS5oYXNUYXNrc1RvUHJvY2VzcygpKSB7XG4gICAgICBfdGFza1F1ZXVlLnByb2Nlc3NOZXh0KCk7XG4gICAgICBpZiAoX2RlYWRsaW5lID4gMCAmJlxuICAgICAgICAgIEJhdGNoZWRCcmlkZ2UuZ2V0RXZlbnRMb29wUnVubmluZ1RpbWUoKSA+PSBfZGVhZGxpbmUpIHtcbiAgICAgICAgLy8gSGl0IGRlYWRsaW5lIGJlZm9yZSBwcm9jZXNzaW5nIGFsbCB0YXNrcywgc28gcHJvY2VzcyBtb3JlIGxhdGVyLlxuICAgICAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIF9hZGRJbnRlcmFjdGlvblNldC5jbGVhcigpO1xuICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuY2xlYXIoKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBJbnRlcmFjdGlvbk1hbmFnZXI7XG4iXX0=