00a832f21bb88d53a6a45e5da5a3bc77
Object.defineProperty(exports,"__esModule",{value:true});exports.EXPO_CONSOLE_METHOD_NAME=undefined;var _prettyFormat=require('pretty-format');var _prettyFormat2=_interopRequireDefault(_prettyFormat);var _parseErrorStack=require('react-native/Libraries/Core/Devtools/parseErrorStack');var _parseErrorStack2=_interopRequireDefault(_parseErrorStack);var _symbolicateStackTrace=require('react-native/Libraries/Core/Devtools/symbolicateStackTrace');var _symbolicateStackTrace2=_interopRequireDefault(_symbolicateStackTrace);require('./RemoteLogging');var _Constants=require('../Constants');var _Constants2=_interopRequireDefault(_Constants);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}var EXPO_CONSOLE_METHOD_NAME=exports.EXPO_CONSOLE_METHOD_NAME='__expoConsoleLog';function serializeLogDataAsync(data,level){var serializedValues,includesStack,rawStack,syntheticError,stack,errorMessage,serializedError,error,_errorMessage,_serializedError;return regeneratorRuntime.async(function serializeLogDataAsync$(_context){while(1){switch(_context.prev=_context.next){case 0:serializedValues=void 0;includesStack=false;if(!_stackTraceLogsSupported()){_context.next=33;break;}if(!_isUnhandledPromiseRejection(data,level)){_context.next=12;break;}rawStack=data[0];syntheticError={stack:rawStack};_context.next=8;return regeneratorRuntime.awrap(_symbolicateErrorAsync(syntheticError));case 8:stack=_context.sent;if(!stack.length){serializedValues=_stringifyLogData(data);}else{errorMessage=rawStack.split('\n')[1];serializedValues=[{message:'[Unhandled promise rejection: '+errorMessage+']',stack:_formatStack(stack)}];includesStack=true;}_context.next=31;break;case 12:if(!(data.length===1&&data[0]instanceof Error)){_context.next=20;break;}_context.next=15;return regeneratorRuntime.awrap(_serializeErrorAsync(data[0]));case 15:serializedError=_context.sent;serializedValues=[serializedError];includesStack=serializedError.hasOwnProperty('stack');_context.next=31;break;case 20:if(!(level==='warn'||level==='error')){_context.next=30;break;}error=_captureConsoleStackTrace();_errorMessage=_stringifyLogData(data).join(', ');_context.next=25;return regeneratorRuntime.awrap(_serializeErrorAsync(error,_errorMessage));case 25:_serializedError=_context.sent;serializedValues=[_serializedError];includesStack=_serializedError.hasOwnProperty('stack');_context.next=31;break;case 30:serializedValues=_stringifyLogData(data);case 31:_context.next=34;break;case 33:serializedValues=_stringifyLogData(data);case 34:return _context.abrupt('return',{body:[].concat(_toConsumableArray(serializedValues)),includesStack:includesStack});case 35:case'end':return _context.stop();}}},null,this);}function _stringifyLogData(data){return data.map(function(item){if(typeof item==='string'){return item;}else{return(0,_prettyFormat2.default)(item);}});}function _serializeErrorAsync(error,message){var stack,formattedStack;return regeneratorRuntime.async(function _serializeErrorAsync$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(message==null){message=error.message;}if(!(!error.stack||!error.stack.length)){_context2.next=3;break;}return _context2.abrupt('return',(0,_prettyFormat2.default)(error));case 3:_context2.next=5;return regeneratorRuntime.awrap(_symbolicateErrorAsync(error));case 5:stack=_context2.sent;formattedStack=_formatStack(stack);return _context2.abrupt('return',{message:message,stack:formattedStack});case 8:case'end':return _context2.stop();}}},null,this);}function _symbolicateErrorAsync(error){var parsedStack,symbolicatedStack;return regeneratorRuntime.async(function _symbolicateErrorAsync$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:parsedStack=(0,_parseErrorStack2.default)(error);symbolicatedStack=void 0;_context3.prev=2;_context3.next=5;return regeneratorRuntime.awrap((0,_symbolicateStackTrace2.default)(parsedStack));case 5:symbolicatedStack=_context3.sent;_context3.next=11;break;case 8:_context3.prev=8;_context3.t0=_context3['catch'](2);return _context3.abrupt('return',parsedStack);case 11:if(symbolicatedStack){_context3.next=13;break;}return _context3.abrupt('return',parsedStack);case 13:return _context3.abrupt('return',symbolicatedStack.map(_removeProjectRoot));case 14:case'end':return _context3.stop();}}},null,this,[[2,8]]);}function _formatStack(stack){return stack.map(function(frame){var line=frame.file+':'+frame.lineNumber;if(frame.column!=null){line+=':'+frame.column;}line+=' in '+frame.methodName;return line;}).join('\n');}function _removeProjectRoot(frame){var filename=frame.file;if(filename==null){return frame;}var projectRoot=_getProjectRoot();if(projectRoot==null){return frame;}if(filename.startsWith(projectRoot)){filename=filename.substring(projectRoot.length);if(filename[0]==='/'||filename[0]==='\\'){filename=filename.substring(1);}frame.file=filename;}return frame;}function _stackTraceLogsSupported(){return!!(__DEV__&&_getProjectRoot());}function _isUnhandledPromiseRejection(data,level){return level==='warn'&&typeof data[0]==='string'&&/^Possible Unhandled Promise Rejection/.test(data[0]);}function _captureConsoleStackTrace(){try{throw new Error();}catch(error){var stackLines=error.stack.split('\n');var consoleMethodIndex=stackLines.findIndex(function(frame){return frame.includes(EXPO_CONSOLE_METHOD_NAME);});if(consoleMethodIndex!==-1){stackLines=stackLines.slice(consoleMethodIndex+1);error.stack=stackLines.join('\n');}return error;}}function _getProjectRoot(){return _Constants2.default.manifest&&_Constants2.default.manifest.developer?_Constants2.default.manifest.developer.projectRoot:null;}exports.default={serializeLogDataAsync:serializeLogDataAsync};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkxvZ1NlcmlhbGl6YXRpb24uanMiXSwibmFtZXMiOlsiRVhQT19DT05TT0xFX01FVEhPRF9OQU1FIiwic2VyaWFsaXplTG9nRGF0YUFzeW5jIiwiZGF0YSIsImxldmVsIiwic2VyaWFsaXplZFZhbHVlcyIsImluY2x1ZGVzU3RhY2siLCJfc3RhY2tUcmFjZUxvZ3NTdXBwb3J0ZWQiLCJfaXNVbmhhbmRsZWRQcm9taXNlUmVqZWN0aW9uIiwicmF3U3RhY2siLCJzeW50aGV0aWNFcnJvciIsInN0YWNrIiwiX3N5bWJvbGljYXRlRXJyb3JBc3luYyIsImxlbmd0aCIsIl9zdHJpbmdpZnlMb2dEYXRhIiwiZXJyb3JNZXNzYWdlIiwic3BsaXQiLCJtZXNzYWdlIiwiX2Zvcm1hdFN0YWNrIiwiRXJyb3IiLCJfc2VyaWFsaXplRXJyb3JBc3luYyIsInNlcmlhbGl6ZWRFcnJvciIsImhhc093blByb3BlcnR5IiwiZXJyb3IiLCJfY2FwdHVyZUNvbnNvbGVTdGFja1RyYWNlIiwiam9pbiIsImJvZHkiLCJtYXAiLCJpdGVtIiwiZm9ybWF0dGVkU3RhY2siLCJwYXJzZWRTdGFjayIsInN5bWJvbGljYXRlZFN0YWNrIiwiX3JlbW92ZVByb2plY3RSb290IiwibGluZSIsImZyYW1lIiwiZmlsZSIsImxpbmVOdW1iZXIiLCJjb2x1bW4iLCJtZXRob2ROYW1lIiwiZmlsZW5hbWUiLCJwcm9qZWN0Um9vdCIsIl9nZXRQcm9qZWN0Um9vdCIsInN0YXJ0c1dpdGgiLCJzdWJzdHJpbmciLCJfX0RFVl9fIiwidGVzdCIsInN0YWNrTGluZXMiLCJjb25zb2xlTWV0aG9kSW5kZXgiLCJmaW5kSW5kZXgiLCJpbmNsdWRlcyIsInNsaWNlIiwiQ29uc3RhbnRzIiwibWFuaWZlc3QiLCJkZXZlbG9wZXIiXSwibWFwcGluZ3MiOiJvR0FFQSwyQyx5REFDQSxxRiwrREFHQSxpRywyRUFFQSwyQkFDQSx1Qyw4U0FPTyxHQUFNQSwyREFBMkIsa0JBQWpDLENBRVAsUUFBZUMsc0JBQWYsQ0FBcUND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QyxJQUF4QyxDQUE2QzFDLEtBQUssQ0FBTCxDQUE3QyxDQUhGLENBS0QsQ0FFRCxRQUFTcUIsMEJBQVQsRUFBNEMsQ0FDMUMsR0FBSSxDQUNGLEtBQU0sSUFBSUwsTUFBSixFQUFOLENBQ0QsQ0FBQyxNQUFPSSxLQUFQLENBQWMsQ0FDZCxHQUFJdUIsWUFBYXZCLE1BQU1aLEtBQU4sQ0FBWUssS0FBWixDQUFrQixJQUFsQixDQUFqQixDQUNBLEdBQUkrQixvQkFBcUJELFdBQVdFLFNBQVgsQ0FBcUIsc0JBQzVDZCxPQUFNZSxRQUFOLENBQWVoRCx3QkFBZixDQUQ0QyxFQUFyQixDQUF6QixDQUdBLEdBQUk4QyxxQkFBdUIsQ0FBQyxDQUE1QixDQUErQixDQUM3QkQsV0FBYUEsV0FBV0ksS0FBWCxDQUFpQkgsbUJBQXFCLENBQXRDLENBQWIsQ0FDQXhCLE1BQU1aLEtBQU4sQ0FBY21DLFdBQVdyQixJQUFYLENBQWdCLElBQWhCLENBQWQsQ0FDRCxDQUNELE1BQU9GLE1BQVAsQ0FDRCxDQUNGLENBRUQsUUFBU2tCLGdCQUFULEVBQW9DLENBQ2xDLE1BQU9VLHFCQUFVQyxRQUFWLEVBQXNCRCxvQkFBVUMsUUFBVixDQUFtQkMsU0FBekMsQ0FDSEYsb0JBQVVDLFFBQVYsQ0FBbUJDLFNBQW5CLENBQTZCYixXQUQxQixDQUVILElBRkosQ0FHRCxDLGdCQUVjLENBQ2J0QywyQ0FEYSxDIiwiZmlsZSI6IkxvZ1NlcmlhbGl6YXRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgcHJldHR5Rm9ybWF0IGZyb20gJ3ByZXR0eS1mb3JtYXQnO1xuaW1wb3J0IHBhcnNlRXJyb3JTdGFjaywge1xuICB0eXBlIFN0YWNrRnJhbWUsXG59IGZyb20gJ3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29yZS9EZXZ0b29scy9wYXJzZUVycm9yU3RhY2snO1xuaW1wb3J0IHN5bWJvbGljYXRlU3RhY2tUcmFjZSBmcm9tICdyZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvcmUvRGV2dG9vbHMvc3ltYm9saWNhdGVTdGFja1RyYWNlJztcblxuaW1wb3J0IHsgdHlwZSBMb2dEYXRhLCB0eXBlIExvZ0xldmVsIH0gZnJvbSAnLi9SZW1vdGVMb2dnaW5nJztcbmltcG9ydCBDb25zdGFudHMgZnJvbSAnLi4vQ29uc3RhbnRzJztcblxudHlwZSBTZXJpYWxpemVkRGF0YSA9IHtcbiAgYm9keTogQXJyYXk8TG9nRGF0YT4sXG4gIGluY2x1ZGVzU3RhY2s6IGJvb2xlYW4sXG59O1xuXG5leHBvcnQgY29uc3QgRVhQT19DT05TT0xFX01FVEhPRF9OQU1FID0gJ19fZXhwb0NvbnNvbGVMb2cnO1xuXG5hc3luYyBmdW5jdGlvbiBzZXJpYWxpemVMb2dEYXRhQXN5bmMoZGF0YTogQXJyYXk8bWl4ZWQ+LCBsZXZlbDogTG9nTGV2ZWwpOiBQcm9taXNlPFNlcmlhbGl6ZWREYXRhPiB7XG4gIGxldCBzZXJpYWxpemVkVmFsdWVzOiAkUmVhZE9ubHlBcnJheTxMb2dEYXRhPjtcbiAgbGV0IGluY2x1ZGVzU3RhY2sgPSBmYWxzZTtcblxuICBpZiAoX3N0YWNrVHJhY2VMb2dzU3VwcG9ydGVkKCkpIHtcbiAgICBpZiAoX2lzVW5oYW5kbGVkUHJvbWlzZVJlamVjdGlvbihkYXRhLCBsZXZlbCkpIHtcbiAgICAgIGxldCByYXdTdGFjayA9ICgoZGF0YVswXTogYW55KTogc3RyaW5nKTtcbiAgICAgIGxldCBzeW50aGV0aWNFcnJvciA9ICh7IHN0YWNrOiByYXdTdGFjayB9OiBhbnkpO1xuICAgICAgbGV0IHN0YWNrID0gYXdhaXQgX3N5bWJvbGljYXRlRXJyb3JBc3luYyhzeW50aGV0aWNFcnJvcik7XG5cbiAgICAgIGlmICghc3RhY2subGVuZ3RoKSB7XG4gICAgICAgIHNlcmlhbGl6ZWRWYWx1ZXMgPSBfc3RyaW5naWZ5TG9nRGF0YShkYXRhKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE5PVEU6IFRoaXMgZG9lc24ndCBoYW5kbGUgZXJyb3IgbWVzc2FnZXMgd2l0aCBuZXdsaW5lc1xuICAgICAgICBsZXQgZXJyb3JNZXNzYWdlID0gcmF3U3RhY2suc3BsaXQoJ1xcbicpWzFdO1xuICAgICAgICBzZXJpYWxpemVkVmFsdWVzID0gW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBbVW5oYW5kbGVkIHByb21pc2UgcmVqZWN0aW9uOiAke2Vycm9yTWVzc2FnZX1dYCxcbiAgICAgICAgICAgIHN0YWNrOiBfZm9ybWF0U3RhY2soc3RhY2spLFxuICAgICAgICAgIH0sXG4gICAgICAgIF07XG4gICAgICAgIGluY2x1ZGVzU3RhY2sgPSB0cnVlO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZGF0YS5sZW5ndGggPT09IDEgJiYgZGF0YVswXSBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAvLyBXaGVuIHRoZXJlJ3Mgb25seSBvbmUgYXJndW1lbnQgdG8gdGhlIGxvZyBmdW5jdGlvbiBhbmQgdGhhdCBhcmd1bWVudCBpcyBhbiBlcnJvciwgd2VcbiAgICAgIC8vIGluY2x1ZGUgdGhlIGVycm9yJ3Mgc3RhY2suIElmIHRoZXJlJ3MgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCB0aGVuIHdlIGRvbid0IGluY2x1ZGUgdGhlXG4gICAgICAvLyBzdGFjayBiZWNhdXNlIGl0J3Mgbm90IGVhc3kgdG8gZGlzcGxheSBuaWNlbHkgaW4gb3VyIGN1cnJlbnQgVUkuXG5cbiAgICAgIGxldCBzZXJpYWxpemVkRXJyb3IgPSBhd2FpdCBfc2VyaWFsaXplRXJyb3JBc3luYyhkYXRhWzBdKTtcbiAgICAgIHNlcmlhbGl6ZWRWYWx1ZXMgPSBbc2VyaWFsaXplZEVycm9yXTtcbiAgICAgIGluY2x1ZGVzU3RhY2sgPSBzZXJpYWxpemVkRXJyb3IuaGFzT3duUHJvcGVydHkoJ3N0YWNrJyk7XG4gICAgfSBlbHNlIGlmIChsZXZlbCA9PT0gJ3dhcm4nIHx8IGxldmVsID09PSAnZXJyb3InKSB7XG4gICAgICAvLyBGb3IgY29uc29sZS53YXJuIGFuZCBjb25zb2xlLmVycm9yIGl0IGlzIHVzdWFsbHkgdXNlZnVsIHRvIGtub3cgdGhlIHN0YWNrIHRoYXQgbGVhZHMgdG8gdGhlXG4gICAgICAvLyB3YXJuaW5nIG9yIGVycm9yLCBzbyB3ZSBwcm92aWRlIHRoaXMgaW5mb3JtYXRpb24gdG8gaGVscCBvdXQgd2l0aCBkZWJ1Z2dpbmdcblxuICAgICAgbGV0IGVycm9yID0gX2NhcHR1cmVDb25zb2xlU3RhY2tUcmFjZSgpO1xuICAgICAgLy8gW1wiaGVsbG9cIiwgXCJ3b3JsZFwiXSBiZWNvbWVzIFwiaGVsbG8sIHdvcmxkXCJcbiAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSBfc3RyaW5naWZ5TG9nRGF0YShkYXRhKS5qb2luKCcsICcpO1xuXG4gICAgICBsZXQgc2VyaWFsaXplZEVycm9yID0gYXdhaXQgX3NlcmlhbGl6ZUVycm9yQXN5bmMoZXJyb3IsIGVycm9yTWVzc2FnZSk7XG4gICAgICBzZXJpYWxpemVkVmFsdWVzID0gW3NlcmlhbGl6ZWRFcnJvcl07XG4gICAgICBpbmNsdWRlc1N0YWNrID0gc2VyaWFsaXplZEVycm9yLmhhc093blByb3BlcnR5KCdzdGFjaycpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZXJpYWxpemVkVmFsdWVzID0gX3N0cmluZ2lmeUxvZ0RhdGEoZGF0YSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHNlcmlhbGl6ZWRWYWx1ZXMgPSBfc3RyaW5naWZ5TG9nRGF0YShkYXRhKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgYm9keTogWy4uLnNlcmlhbGl6ZWRWYWx1ZXNdLFxuICAgIGluY2x1ZGVzU3RhY2ssXG4gIH07XG59XG5cbmZ1bmN0aW9uIF9zdHJpbmdpZnlMb2dEYXRhKGRhdGE6IEFycmF5PG1peGVkPik6IEFycmF5PHN0cmluZz4ge1xuICByZXR1cm4gZGF0YS5tYXAoaXRlbSA9PiB7XG4gICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIGl0ZW07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBwcmV0dHlGb3JtYXQoaXRlbSk7XG4gICAgfVxuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX3NlcmlhbGl6ZUVycm9yQXN5bmMoZXJyb3I6IEVycm9yLCBtZXNzYWdlPzogc3RyaW5nKTogUHJvbWlzZTxMb2dEYXRhPiB7XG4gIGlmIChtZXNzYWdlID09IG51bGwpIHtcbiAgICBtZXNzYWdlID0gZXJyb3IubWVzc2FnZTtcbiAgfVxuXG4gIGlmICghZXJyb3Iuc3RhY2sgfHwgIWVycm9yLnN0YWNrLmxlbmd0aCkge1xuICAgIHJldHVybiBwcmV0dHlGb3JtYXQoZXJyb3IpO1xuICB9XG5cbiAgbGV0IHN0YWNrID0gYXdhaXQgX3N5bWJvbGljYXRlRXJyb3JBc3luYyhlcnJvcik7XG4gIGxldCBmb3JtYXR0ZWRTdGFjayA9IF9mb3JtYXRTdGFjayhzdGFjayk7XG5cbiAgcmV0dXJuIHsgbWVzc2FnZSwgc3RhY2s6IGZvcm1hdHRlZFN0YWNrIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIF9zeW1ib2xpY2F0ZUVycm9yQXN5bmMoZXJyb3I6IEVycm9yKTogUHJvbWlzZTxBcnJheTxTdGFja0ZyYW1lPj4ge1xuICBsZXQgcGFyc2VkU3RhY2sgPSBwYXJzZUVycm9yU3RhY2soZXJyb3IpO1xuICBsZXQgc3ltYm9saWNhdGVkU3RhY2s6ID9BcnJheTxTdGFja0ZyYW1lPjtcbiAgdHJ5IHtcbiAgICBzeW1ib2xpY2F0ZWRTdGFjayA9IGF3YWl0IHN5bWJvbGljYXRlU3RhY2tUcmFjZShwYXJzZWRTdGFjayk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIHBhcnNlZFN0YWNrO1xuICB9XG5cbiAgLy8gSW4gdGhpcyBjb250ZXh0IGFuIHVuc3ltYm9saWNhdGVkIHN0YWNrIGlzIGJldHRlciB0aGFuIG5vIHN0YWNrXG4gIGlmICghc3ltYm9saWNhdGVkU3RhY2spIHtcbiAgICByZXR1cm4gcGFyc2VkU3RhY2s7XG4gIH1cblxuICAvLyBDbGVhbiB0aGUgc3RhY2sgdHJhY2VcbiAgcmV0dXJuIHN5bWJvbGljYXRlZFN0YWNrLm1hcChfcmVtb3ZlUHJvamVjdFJvb3QpO1xufVxuXG5mdW5jdGlvbiBfZm9ybWF0U3RhY2soc3RhY2s6IEFycmF5PFN0YWNrRnJhbWU+KTogc3RyaW5nIHtcbiAgcmV0dXJuIHN0YWNrXG4gICAgLm1hcChmcmFtZSA9PiB7XG4gICAgICBsZXQgbGluZSA9IGAke2ZyYW1lLmZpbGV9OiR7ZnJhbWUubGluZU51bWJlcn1gO1xuICAgICAgaWYgKGZyYW1lLmNvbHVtbiAhPSBudWxsKSB7XG4gICAgICAgIGxpbmUgKz0gYDoke2ZyYW1lLmNvbHVtbn1gO1xuICAgICAgfVxuICAgICAgbGluZSArPSBgIGluICR7ZnJhbWUubWV0aG9kTmFtZX1gO1xuICAgICAgcmV0dXJuIGxpbmU7XG4gICAgfSlcbiAgICAuam9pbignXFxuJyk7XG59XG5cbmZ1bmN0aW9uIF9yZW1vdmVQcm9qZWN0Um9vdChmcmFtZTogU3RhY2tGcmFtZSk6IFN0YWNrRnJhbWUge1xuICBsZXQgZmlsZW5hbWUgPSBmcmFtZS5maWxlO1xuICBpZiAoZmlsZW5hbWUgPT0gbnVsbCkge1xuICAgIHJldHVybiBmcmFtZTtcbiAgfVxuXG4gIGxldCBwcm9qZWN0Um9vdCA9IF9nZXRQcm9qZWN0Um9vdCgpO1xuICBpZiAocHJvamVjdFJvb3QgPT0gbnVsbCkge1xuICAgIHJldHVybiBmcmFtZTtcbiAgfVxuXG4gIGlmIChmaWxlbmFtZS5zdGFydHNXaXRoKHByb2plY3RSb290KSkge1xuICAgIGZpbGVuYW1lID0gZmlsZW5hbWUuc3Vic3RyaW5nKHByb2plY3RSb290Lmxlbmd0aCk7XG4gICAgaWYgKGZpbGVuYW1lWzBdID09PSAnLycgfHwgZmlsZW5hbWVbMF0gPT09ICdcXFxcJykge1xuICAgICAgZmlsZW5hbWUgPSBmaWxlbmFtZS5zdWJzdHJpbmcoMSk7XG4gICAgfVxuICAgIGZyYW1lLmZpbGUgPSBmaWxlbmFtZTtcbiAgfVxuXG4gIHJldHVybiBmcmFtZTtcbn1cblxuLyoqXG4gKiBSZXR1cm5zIHdoZXRoZXIgdGhlIGRldmVsb3BtZW50IHNlcnZlciB0aGF0IHNlcnZlZCB0aGlzIHByb2plY3Qgc3VwcG9ydHMgbG9ncyB3aXRoIGEgc3RhY2sgdHJhY2UuXG4gKiBTcGVjaWZpY2FsbHksIHRoZSB2ZXJzaW9uIG9mIGV4cC9YREUgdGhhdCBpbmNsdWRlcyBgcHJvamVjdFJvb3RgIGluIHRoZSBtYW5pZmVzdCBhbHNvIGFjY2VwdHNcbiAqIHBheWxvYWRzIG9mIHRoZSBmb3JtOlxuICpcbiAqIHtcbiAqICAgaW5jbHVkZXNTdGFjazogYm9vbGVhbiwgYm9keTogW3sgbWVzc2FnZTogc3RyaW5nLCBzdGFjazogc3RyaW5nIH1dLFxuICogfVxuICovXG5mdW5jdGlvbiBfc3RhY2tUcmFjZUxvZ3NTdXBwb3J0ZWQoKTogYm9vbGVhbiB7XG4gIHJldHVybiAhIShfX0RFVl9fICYmIF9nZXRQcm9qZWN0Um9vdCgpKTtcbn1cblxuZnVuY3Rpb24gX2lzVW5oYW5kbGVkUHJvbWlzZVJlamVjdGlvbihkYXRhOiBBcnJheTxtaXhlZD4sIGxldmVsOiBMb2dMZXZlbCk6IGJvb2xlYW4ge1xuICByZXR1cm4gKFxuICAgIGxldmVsID09PSAnd2FybicgJiZcbiAgICB0eXBlb2YgZGF0YVswXSA9PT0gJ3N0cmluZycgJiZcbiAgICAvXlBvc3NpYmxlIFVuaGFuZGxlZCBQcm9taXNlIFJlamVjdGlvbi8udGVzdChkYXRhWzBdKVxuICApO1xufVxuXG5mdW5jdGlvbiBfY2FwdHVyZUNvbnNvbGVTdGFja1RyYWNlKCk6IEVycm9yIHtcbiAgdHJ5IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsZXQgc3RhY2tMaW5lcyA9IGVycm9yLnN0YWNrLnNwbGl0KCdcXG4nKTtcbiAgICBsZXQgY29uc29sZU1ldGhvZEluZGV4ID0gc3RhY2tMaW5lcy5maW5kSW5kZXgoZnJhbWUgPT5cbiAgICAgIGZyYW1lLmluY2x1ZGVzKEVYUE9fQ09OU09MRV9NRVRIT0RfTkFNRSlcbiAgICApO1xuICAgIGlmIChjb25zb2xlTWV0aG9kSW5kZXggIT09IC0xKSB7XG4gICAgICBzdGFja0xpbmVzID0gc3RhY2tMaW5lcy5zbGljZShjb25zb2xlTWV0aG9kSW5kZXggKyAxKTtcbiAgICAgIGVycm9yLnN0YWNrID0gc3RhY2tMaW5lcy5qb2luKCdcXG4nKTtcbiAgICB9XG4gICAgcmV0dXJuIGVycm9yO1xuICB9XG59XG5cbmZ1bmN0aW9uIF9nZXRQcm9qZWN0Um9vdCgpOiA/c3RyaW5nIHtcbiAgcmV0dXJuIENvbnN0YW50cy5tYW5pZmVzdCAmJiBDb25zdGFudHMubWFuaWZlc3QuZGV2ZWxvcGVyXG4gICAgPyBDb25zdGFudHMubWFuaWZlc3QuZGV2ZWxvcGVyLnByb2plY3RSb290XG4gICAgOiBudWxsO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIHNlcmlhbGl6ZUxvZ0RhdGFBc3luYyxcbn07XG4iXX0=