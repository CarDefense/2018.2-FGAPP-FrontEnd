742af620538bf5af5b1f4d2ac735b4a1
Object.defineProperty(exports,"__esModule",{value:true});var _invariant=require('invariant');var _invariant2=_interopRequireDefault(_invariant);var _reactNative=require('react-native');var _Permissions=require('./Permissions');var Permissions=_interopRequireWildcard(_Permissions);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var LocationEventEmitter=new _reactNative.NativeEventEmitter(_reactNative.NativeModules.ExponentLocation);var ExponentLocation=_reactNative.NativeModules.ExponentLocation;var nextWatchId=0;var headingId=void 0;function _getNextWatchId(){nextWatchId++;return nextWatchId;}function _getCurrentWatchId(){return nextWatchId;}var watchCallbacks={};var deviceEventSubscription=void 0;var headingEventSub=void 0;var googleApiKey=void 0;var googleApiUrl='https://maps.googleapis.com/maps/api/geocode/json';function getProviderStatusAsync(){return ExponentLocation.getProviderStatusAsync();}function getCurrentPositionAsync(){var _this=this;var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(_reactNative.Platform.OS==='android'){return ExponentLocation.getCurrentPositionAsync(options);}return new Promise(function _callee(resolve,reject){var done,subscription;return regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;done=false;subscription=void 0;_context.next=5;return regeneratorRuntime.awrap(watchPositionAsync(options,function(location){if(!done){resolve(location);done=true;}subscription&&subscription.remove();subscription=null;}));case 5:subscription=_context.sent;if(done){subscription&&subscription.remove();subscription=null;}_context.next=12;break;case 9:_context.prev=9;_context.t0=_context['catch'](0);reject(_context.t0);case 12:case'end':return _context.stop();}}},null,_this,[[0,9]]);});}function getHeadingAsync(){var _this2=this;return regeneratorRuntime.async(function getHeadingAsync$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:return _context3.abrupt('return',new Promise(function _callee2(resolve,reject){var tries,headingSub,done,subscription,_tries;return regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;if(!headingEventSub){_context2.next=6;break;}tries=0;headingSub=LocationEventEmitter.addListener('Exponent.headingChanged',function(_ref){var watchId=_ref.watchId,heading=_ref.heading;if(heading.accuracy>1||tries>5){resolve(heading);LocationEventEmitter.removeSubscription(headingSub);}else{tries+=1;}});_context2.next=13;break;case 6:done=false;subscription=void 0;_tries=0;_context2.next=11;return regeneratorRuntime.awrap(watchHeadingAsync(function(heading){if(!done){if(heading.accuracy>1||_tries>5){subscription.remove();resolve(heading);done=true;}else{_tries+=1;}}else{subscription.remove();}}));case 11:subscription=_context2.sent;if(done){subscription.remove();}case 13:_context2.next=18;break;case 15:_context2.prev=15;_context2.t0=_context2['catch'](0);reject(_context2.t0);case 18:case'end':return _context2.stop();}}},null,_this2,[[0,15]]);}));case 1:case'end':return _context3.stop();}}},null,this);}function watchHeadingAsync(callback){return regeneratorRuntime.async(function watchHeadingAsync$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(headingEventSub){_removeHeadingWatcher(headingId);}headingEventSub=LocationEventEmitter.addListener('Exponent.headingChanged',function(_ref2){var watchId=_ref2.watchId,heading=_ref2.heading;var callback=watchCallbacks[watchId];if(callback){callback(heading);}else{ExponentLocation.removeWatchAsync(watchId);}});headingId=_getNextWatchId();watchCallbacks[headingId]=callback;_context4.next=6;return regeneratorRuntime.awrap(ExponentLocation.watchDeviceHeading(headingId));case 6:return _context4.abrupt('return',{remove:function remove(){_removeHeadingWatcher(headingId);}});case 7:case'end':return _context4.stop();}}},null,this);}function _removeHeadingWatcher(watchId){if(!watchCallbacks[watchId]){return;}delete watchCallbacks[watchId];ExponentLocation.removeWatchAsync(watchId);LocationEventEmitter.removeSubscription(headingEventSub);headingEventSub=null;}function _maybeInitializeEmitterSubscription(){if(!deviceEventSubscription){deviceEventSubscription=LocationEventEmitter.addListener('Exponent.locationChanged',function(_ref3){var watchId=_ref3.watchId,location=_ref3.location;var callback=watchCallbacks[watchId];if(callback){callback(location);}else{ExponentLocation.removeWatchAsync(watchId);}});}}function _askPermissionForWatchAsync(success,error,options,watchId){var _ref4,status;return regeneratorRuntime.async(function _askPermissionForWatchAsync$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return regeneratorRuntime.awrap(Permissions.askAsync(Permissions.LOCATION));case 2:_ref4=_context5.sent;status=_ref4.status;if(status==='granted'){ExponentLocation.watchPositionImplAsync(watchId,options);}else{_removeWatcher(watchId);error({watchId:watchId,message:'No permission to access location'});}case 5:case'end':return _context5.stop();}}},null,this);}function geocodeAsync(address){return regeneratorRuntime.async(function geocodeAsync$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:return _context6.abrupt('return',ExponentLocation.geocodeAsync(address).catch(function(error){if(_reactNative.Platform.OS==='android'&&error.code==='E_NO_GEOCODER'){if(!googleApiKey){throw new Error(error.message+' Please set a Google API Key to use geocoding.');}return _googleGeocodeAsync(address);}throw error;}));case 1:case'end':return _context6.stop();}}},null,this);}function reverseGeocodeAsync(location){return regeneratorRuntime.async(function reverseGeocodeAsync$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:if(!(typeof location.latitude!=='number'||typeof location.longitude!=='number')){_context7.next=2;break;}throw new TypeError('Location should be an object with number properties `latitude` and `longitude`.');case 2:return _context7.abrupt('return',ExponentLocation.reverseGeocodeAsync(location).catch(function(error){if(_reactNative.Platform.OS==='android'&&error.code==='E_NO_GEOCODER'){if(!googleApiKey){throw new Error(error.message+' Please set a Google API Key to use geocoding.');}return _googleReverseGeocodeAsync(location);}throw error;}));case 3:case'end':return _context7.stop();}}},null,this);}function setApiKey(apiKey){googleApiKey=apiKey;}function _googleGeocodeAsync(address){var result,resultObject;return regeneratorRuntime.async(function _googleGeocodeAsync$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.next=2;return regeneratorRuntime.awrap(fetch(googleApiUrl+'?key='+googleApiKey+'&address='+encodeURI(address)));case 2:result=_context8.sent;_context8.next=5;return regeneratorRuntime.awrap(result.json());case 5:resultObject=_context8.sent;if(!(resultObject.status!=='OK')){_context8.next=8;break;}throw new Error('An error occurred during geocoding.');case 8:return _context8.abrupt('return',resultObject.results.map(function(result){var location=result.geometry.location;return{latitude:location.lat,longitude:location.lng};}));case 9:case'end':return _context8.stop();}}},null,this);}function _googleReverseGeocodeAsync(options){var result,resultObject;return regeneratorRuntime.async(function _googleReverseGeocodeAsync$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return regeneratorRuntime.awrap(fetch(googleApiUrl+'?key='+googleApiKey+'&latlng='+options.latitude+','+options.longitude));case 2:result=_context9.sent;_context9.next=5;return regeneratorRuntime.awrap(result.json());case 5:resultObject=_context9.sent;if(!(resultObject.status!=='OK')){_context9.next=8;break;}throw new Error('An error occurred during geocoding.');case 8:return _context9.abrupt('return',resultObject.results.map(function(result){var address={};result.address_components.forEach(function(component){if(component.types.includes('locality')){address.city=component.long_name;}else if(component.types.includes('street_address')){address.street=component.long_name;}else if(component.types.includes('administrative_area_level_1')){address.region=component.long_name;}else if(component.types.includes('country')){address.country=component.long_name;}else if(component.types.includes('postal_code')){address.postalCode=component.long_name;}else if(component.types.includes('point_of_interest')){address.name=component.long_name;}});return address;}));case 9:case'end':return _context9.stop();}}},null,this);}function watchPosition(success,error,options){_maybeInitializeEmitterSubscription();var watchId=_getNextWatchId();watchCallbacks[watchId]=success;_askPermissionForWatchAsync(success,error,options,watchId);return watchId;}function watchPositionAsync(options,callback){var watchId;return regeneratorRuntime.async(function watchPositionAsync$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:_maybeInitializeEmitterSubscription();watchId=_getNextWatchId();watchCallbacks[watchId]=callback;_context10.next=5;return regeneratorRuntime.awrap(ExponentLocation.watchPositionImplAsync(watchId,options));case 5:return _context10.abrupt('return',{remove:function remove(){_removeWatcher(watchId);}});case 6:case'end':return _context10.stop();}}},null,this);}function clearWatch(watchId){_removeWatcher(watchId);}function _removeWatcher(watchId){if(!watchCallbacks[watchId]){return;}ExponentLocation.removeWatchAsync(watchId);delete watchCallbacks[watchId];if(Object.keys(watchCallbacks).length===0){LocationEventEmitter.removeSubscription(deviceEventSubscription);deviceEventSubscription=null;}}function getCurrentPosition(success){var error=arguments.length>1&&arguments[1]!==undefined?arguments[1]:function(){};var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};(0,_invariant2.default)(typeof success==='function','Must provide a valid success callback.');(0,_invariant2.default)(typeof options==='object','options must be an object.');_getCurrentPositionAsyncWrapper(success,error,options);}function _getCurrentPositionAsyncWrapper(success,error,options){var _ref5,status,result;return regeneratorRuntime.async(function _getCurrentPositionAsyncWrapper$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.prev=0;_context11.next=3;return regeneratorRuntime.awrap(Permissions.askAsync(Permissions.LOCATION));case 3:_ref5=_context11.sent;status=_ref5.status;if(!(status!=='granted')){_context11.next=7;break;}throw new Error('Permission to access location not granted. User must now enable it manually in settings');case 7:_context11.next=9;return regeneratorRuntime.awrap(Location.getCurrentPositionAsync(options));case 9:result=_context11.sent;success(result);_context11.next=16;break;case 13:_context11.prev=13;_context11.t0=_context11['catch'](0);error(_context11.t0);case 16:case'end':return _context11.stop();}}},null,this,[[0,13]]);}window.navigator.geolocation={getCurrentPosition:getCurrentPosition,watchPosition:watchPosition,clearWatch:clearWatch,stopObserving:function stopObserving(){}};var Location={getProviderStatusAsync:getProviderStatusAsync,getCurrentPositionAsync:getCurrentPositionAsync,watchPositionAsync:watchPositionAsync,getHeadingAsync:getHeadingAsync,watchHeadingAsync:watchHeadingAsync,geocodeAsync:geocodeAsync,reverseGeocodeAsync:reverseGeocodeAsync,setApiKey:setApiKey,EventEmitter:LocationEventEmitter,_getCurrentWatchId:_getCurrentWatchId};exports.default=Location;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkxvY2F0aW9uLmpzIl0sIm5hbWVzIjpbIlBlcm1pc3Npb25zIiwiTG9jYXRpb25FdmVudEVtaXR0ZXIiLCJOYXRpdmVFdmVudEVtaXR0ZXIiLCJOYXRpdmVNb2R1bGVzIiwiRXhwb25lbnRMb2NhdGlvbiIsIm5leHRXYXRjaElkIiwiaGVhZGluZ0lkIiwiX2dldE5leHRXYXRjaElkIiwiX2dldEN1cnJlbnRXYXRjaElkIiwid2F0Y2hDYWxsYmFja3MiLCJkZXZpY2VFdmVudFN1YnNjcmlwdGlvbiIsImhlYWRpbmdFdmVudFN1YiIsImdvb2dsZUFwaUtleSIsImdvb2dsZUFwaVVybCIsImdldFByb3ZpZGVyU3RhdHVzQXN5bmMiLCJnZXRDdXJyZW50UG9zaXRpb25Bc3luYyIsIm9wdGlvbnMiLCJQbGF0Zm9ybSIsIk9TIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJkb25lIiwic3Vic2NyaXB0aW9uIiwid2F0Y2hQb3NpdGlvbkFzeW5jIiwibG9jYXRpb24iLCJyZW1vdmUiLCJnZXRIZWFkaW5nQXN5bmMiLCJ0cmllcyIsImhlYWRpbmdTdWIiLCJhZGRMaXN0ZW5lciIsIndhdGNoSWQiLCJoZWFkaW5nIiwiYWNjdXJhY3kiLCJyZW1vdmVTdWJzY3JpcHRpb24iLCJ3YXRjaEhlYWRpbmdBc3luYyIsImNhbGxiYWNrIiwiX3JlbW92ZUhlYWRpbmdXYXRjaGVyIiwicmVtb3ZlV2F0Y2hBc3luYyIsIndhdGNoRGV2aWNlSGVhZGluZyIsIl9tYXliZUluaXRpYWxpemVFbWl0dGVyU3Vic2NyaXB0aW9uIiwiX2Fza1Blcm1pc3Npb25Gb3JXYXRjaEFzeW5jIiwic3VjY2VzcyIsImVycm9yIiwiYXNrQXN5bmMiLCJMT0NBVElPTiIsInN0YXR1cyIsIndhdGNoUG9zaXRpb25JbXBsQXN5bmMiLCJfcmVtb3ZlV2F0Y2hlciIsIm1lc3NhZ2UiLCJnZW9jb2RlQXN5bmMiLCJhZGRyZXNzIiwiY2F0Y2giLCJjb2RlIiwiRXJyb3IiLCJfZ29vZ2xlR2VvY29kZUFzeW5jIiwicmV2ZXJzZUdlb2NvZGVBc3luYyIsImxhdGl0dWRlIiwibG9uZ2l0dWRlIiwiVHlwZUVycm9yIiwiX2dvb2dsZVJldmVyc2VHZW9jb2RlQXN5bmMiLCJzZXRBcGlLZXkiLCJhcGlLZXkiLCJmZXRjaCIsImVuY29kZVVSSSIsInJlc3VsdCIsImpzb24iLCJyZXN1bHRPYmplY3QiLCJyZXN1bHRzIiwibWFwIiwiZ2VvbWV0cnkiLCJsYXQiLCJsbmciLCJhZGRyZXNzX2NvbXBvbmVudHMiLCJmb3JFYWNoIiwiY29tcG9uZW50IiwidHlwZXMiLCJpbmNsdWRlcyIsImNpdHkiLCJsb25nX25hbWUiLCJzdHJlZXQiLCJyZWdpb24iLCJjb3VudHJ5IiwicG9zdGFsQ29kZSIsIm5hbWUiLCJ3YXRjaFBvc2l0aW9uIiwiY2xlYXJXYXRjaCIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJnZXRDdXJyZW50UG9zaXRpb24iLCJfZ2V0Q3VycmVudFBvc2l0aW9uQXN5bmNXcmFwcGVyIiwiTG9jYXRpb24iLCJ3aW5kb3ciLCJuYXZpZ2F0b3IiLCJnZW9sb2NhdGlvbiIsInN0b3BPYnNlcnZpbmciLCJFdmVudEVtaXR0ZXIiXSwibWFwcGluZ3MiOiJ5REFDQSxvQyxtREFDQSx5Q0FFQSwwQyxHQUFZQSxZLG9XQUVaLEdBQU1DLHNCQUF1QixHQUFJQyxnQ0FBSixDQUF1QkMsMkJBQWNDLGdCQUFyQyxDQUE3QixDLEdBb0NRQSxpQixDQUFxQkQsMEIsQ0FBckJDLGdCLENBRVIsR0FBSUMsYUFBYyxDQUFsQixDQUNBLEdBQUlDLGlCQUFKLENBQ0EsUUFBU0MsZ0JBQVQsRUFBMkIsQ0FDekJGLGNBQ0EsTUFBT0EsWUFBUCxDQUNELENBQ0QsUUFBU0csbUJBQVQsRUFBOEIsQ0FDNUIsTUFBT0gsWUFBUCxDQUNELENBRUQsR0FBSUksZ0JBRUEsRUFGSixDQUdBLEdBQUlDLCtCQUFKLENBQ0EsR0FBSUMsdUJBQUosQ0FDQSxHQUFJQyxvQkFBSixDQUNBLEdBQU1DLGNBQWUsbURBQXJCLENBRUEsUUFBU0MsdUJBQVQs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OUUsNkNBRGUsQ0FFZkMsK0NBRmUsQ0FHZlMscUNBSGUsQ0FJZkcsK0JBSmUsQ0FLZlEsbUNBTGUsQ0FNZmUseUJBTmUsQ0FPZk0sdUNBUGUsQ0FRZkssbUJBUmUsQ0FXZm9DLGFBQWNoRyxvQkFYQyxDQVlmTyxxQ0FaZSxDQUFqQixDLGdCQWVlb0YsUSIsImZpbGUiOiJMb2NhdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5pbXBvcnQgaW52YXJpYW50IGZyb20gJ2ludmFyaWFudCc7XG5pbXBvcnQgeyBOYXRpdmVFdmVudEVtaXR0ZXIsIE5hdGl2ZU1vZHVsZXMsIFBsYXRmb3JtIH0gZnJvbSAncmVhY3QtbmF0aXZlJztcblxuaW1wb3J0ICogYXMgUGVybWlzc2lvbnMgZnJvbSAnLi9QZXJtaXNzaW9ucyc7XG5cbmNvbnN0IExvY2F0aW9uRXZlbnRFbWl0dGVyID0gbmV3IE5hdGl2ZUV2ZW50RW1pdHRlcihOYXRpdmVNb2R1bGVzLkV4cG9uZW50TG9jYXRpb24pO1xuXG50eXBlIFByb3ZpZGVyU3RhdHVzID0ge1xuICBsb2NhdGlvblNlcnZpY2VzRW5hYmxlZDogYm9vbGVhbixcbiAgZ3BzQXZhaWxhYmxlOiA/Ym9vbGVhbixcbiAgbmV0d29ya0F2YWlsYWJsZTogP2Jvb2xlYW4sXG4gIHBhc3NpdmVBdmFpbGFibGU6ID9ib29sZWFuLFxufTtcblxudHlwZSBMb2NhdGlvbk9wdGlvbnMgPSB7XG4gIGVuYWJsZUhpZ2hBY2N1cmFjeT86IGJvb2xlYW4sXG4gIHRpbWVJbnRlcnZhbD86IG51bWJlcixcbiAgZGlzdGFuY2VJbnRlcnZhbD86IG51bWJlcixcbn07XG5cbnR5cGUgTG9jYXRpb25EYXRhID0ge1xuICBjb29yZHM6IHtcbiAgICBsYXRpdHVkZTogbnVtYmVyLFxuICAgIGxvbmdpdHVkZTogbnVtYmVyLFxuICAgIGFsdGl0dWRlOiBudW1iZXIsXG4gICAgYWNjdXJhY3k6IG51bWJlcixcbiAgICBoZWFkaW5nOiBudW1iZXIsXG4gICAgc3BlZWQ6IG51bWJlcixcbiAgfSxcbiAgdGltZXN0YW1wOiBudW1iZXIsXG59O1xuXG50eXBlIEhlYWRpbmdEYXRhID0ge1xuICB0cnVlSGVhZGluZzogbnVtYmVyLFxuICBtYWdIZWFkaW5nOiBudW1iZXIsXG4gIGFjY3VyYWN5OiBudW1iZXIsXG59O1xuXG50eXBlIExvY2F0aW9uQ2FsbGJhY2sgPSAoZGF0YTogTG9jYXRpb25EYXRhKSA9PiBhbnk7XG50eXBlIEhlYWRpbmdDYWxsYmFjayA9IChkYXRhOiBIZWFkaW5nRGF0YSkgPT4gYW55O1xuXG5jb25zdCB7IEV4cG9uZW50TG9jYXRpb24gfSA9IE5hdGl2ZU1vZHVsZXM7XG5cbmxldCBuZXh0V2F0Y2hJZCA9IDA7XG5sZXQgaGVhZGluZ0lkO1xuZnVuY3Rpb24gX2dldE5leHRXYXRjaElkKCkge1xuICBuZXh0V2F0Y2hJZCsrO1xuICByZXR1cm4gbmV4dFdhdGNoSWQ7XG59XG5mdW5jdGlvbiBfZ2V0Q3VycmVudFdhdGNoSWQoKSB7XG4gIHJldHVybiBuZXh0V2F0Y2hJZDtcbn1cblxubGV0IHdhdGNoQ2FsbGJhY2tzOiB7XG4gIFt3YXRjaElkOiBudW1iZXJdOiBMb2NhdGlvbkNhbGxiYWNrIHwgSGVhZGluZ0NhbGxiYWNrLFxufSA9IHt9O1xubGV0IGRldmljZUV2ZW50U3Vic2NyaXB0aW9uOiA/RnVuY3Rpb247XG5sZXQgaGVhZGluZ0V2ZW50U3ViOiA/RnVuY3Rpb247XG5sZXQgZ29vZ2xlQXBpS2V5O1xuY29uc3QgZ29vZ2xlQXBpVXJsID0gJ2h0dHBzOi8vbWFwcy5nb29nbGVhcGlzLmNvbS9tYXBzL2FwaS9nZW9jb2RlL2pzb24nO1xuXG5mdW5jdGlvbiBnZXRQcm92aWRlclN0YXR1c0FzeW5jKCk6IFByb21pc2U8UHJvdmlkZXJTdGF0dXM+IHtcbiAgcmV0dXJuIEV4cG9uZW50TG9jYXRpb24uZ2V0UHJvdmlkZXJTdGF0dXNBc3luYygpO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50UG9zaXRpb25Bc3luYyhvcHRpb25zOiBMb2NhdGlvbk9wdGlvbnMgPSB7fSk6IFByb21pc2U8TG9jYXRpb25EYXRhPiB7XG4gIC8vIE9uIEFuZHJvaWQgd2UgaGF2ZSBhIG5hdGl2ZSBtZXRob2QgZm9yIHRoaXMgY2FzZS5cbiAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHtcbiAgICByZXR1cm4gRXhwb25lbnRMb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb25Bc3luYyhvcHRpb25zKTtcbiAgfVxuXG4gIC8vIE9uIGlPUyB3ZSBpbXBsZW1lbnQgaXQgaW4gdGVybXMgb2YgYC53YXRjaFBvc2l0aW9uQXN5bmMoLi4uKWBcbiAgLy8gVE9ETzogVXNlIHNlcGFyYXRlIG5hdGl2ZSBtZXRob2QgZm9yIGlPUyB0b28/XG4gIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBkb25lID0gZmFsc2U7IC8vIFRvIG1ha2Ugc3VyZSB3ZSBvbmx5IHJlc29sdmUgb25jZS5cbiAgICAgIGxldCBzdWJzY3JpcHRpb247XG4gICAgICBzdWJzY3JpcHRpb24gPSBhd2FpdCB3YXRjaFBvc2l0aW9uQXN5bmMob3B0aW9ucywgbG9jYXRpb24gPT4ge1xuICAgICAgICBpZiAoIWRvbmUpIHtcbiAgICAgICAgICByZXNvbHZlKGxvY2F0aW9uKTtcbiAgICAgICAgICBkb25lID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBzdWJzY3JpcHRpb24gJiYgc3Vic2NyaXB0aW9uLnJlbW92ZSgpO1xuICAgICAgICBzdWJzY3JpcHRpb24gPSBudWxsO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIEluIGNhc2UgdGhlIGNhbGxiYWNrIGlzIGZpcmVkIGJlZm9yZSB3ZSBnZXQgaGVyZS5cbiAgICAgIGlmIChkb25lKSB7XG4gICAgICAgIHN1YnNjcmlwdGlvbiAmJiBzdWJzY3JpcHRpb24ucmVtb3ZlKCk7XG4gICAgICAgIHN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmVqZWN0KGUpO1xuICAgIH1cbiAgfSk7XG59XG5cbi8vIFN0YXJ0IENvbXBhc3MgTW9kdWxlXG5cbi8vIFRvIHNpbXBsaWZ5LCB3ZSB3aWxsIGNhbGwgd2F0Y2hIZWFkaW5nQXN5bmMgYW5kIHdhaXQgZm9yIG9uZSB1cGRhdGUgVG8gZW5zdXJlIGFjY3VyYWN5LCB3ZSB3YWl0XG4vLyBmb3IgYSBjb3VwbGUgb2Ygd2F0Y2ggdXBkYXRlcyBpZiB0aGUgZGF0YSBoYXMgbG93IGFjY3VyYWN5XG5hc3luYyBmdW5jdGlvbiBnZXRIZWFkaW5nQXN5bmMoKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIElmIHRoZXJlIGlzIGFscmVhZHkgYSBjb21wYXNzIGFjdGl2ZSAod291bGQgYmUgYSB3YXRjaClcbiAgICAgIGlmIChoZWFkaW5nRXZlbnRTdWIpIHtcbiAgICAgICAgbGV0IHRyaWVzID0gMDtcbiAgICAgICAgY29uc3QgaGVhZGluZ1N1YiA9IExvY2F0aW9uRXZlbnRFbWl0dGVyLmFkZExpc3RlbmVyKFxuICAgICAgICAgICdFeHBvbmVudC5oZWFkaW5nQ2hhbmdlZCcsXG4gICAgICAgICAgKHsgd2F0Y2hJZCwgaGVhZGluZyB9KSA9PiB7XG4gICAgICAgICAgICBpZiAoaGVhZGluZy5hY2N1cmFjeSA+IDEgfHwgdHJpZXMgPiA1KSB7XG4gICAgICAgICAgICAgIHJlc29sdmUoaGVhZGluZyk7XG4gICAgICAgICAgICAgIExvY2F0aW9uRXZlbnRFbWl0dGVyLnJlbW92ZVN1YnNjcmlwdGlvbihoZWFkaW5nU3ViKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRyaWVzICs9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IGRvbmUgPSBmYWxzZTtcbiAgICAgICAgbGV0IHN1YnNjcmlwdGlvbjtcbiAgICAgICAgbGV0IHRyaWVzID0gMDtcbiAgICAgICAgc3Vic2NyaXB0aW9uID0gYXdhaXQgd2F0Y2hIZWFkaW5nQXN5bmMoaGVhZGluZyA9PiB7XG4gICAgICAgICAgaWYgKCFkb25lKSB7XG4gICAgICAgICAgICBpZiAoaGVhZGluZy5hY2N1cmFjeSA+IDEgfHwgdHJpZXMgPiA1KSB7XG4gICAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgcmVzb2x2ZShoZWFkaW5nKTtcbiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0cmllcyArPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdWJzY3JpcHRpb24ucmVtb3ZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZG9uZSkge1xuICAgICAgICAgIHN1YnNjcmlwdGlvbi5yZW1vdmUoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJlamVjdChlKTtcbiAgICB9XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiB3YXRjaEhlYWRpbmdBc3luYyhjYWxsYmFjazogSGVhZGluZ0NhbGxiYWNrKSB7XG4gIC8vIENoZWNrIGlmIHRoZXJlIGlzIGFscmVhZHkgYSBjb21wYXNzIGV2ZW50IHdhdGNoLlxuICBpZiAoaGVhZGluZ0V2ZW50U3ViKSB7XG4gICAgX3JlbW92ZUhlYWRpbmdXYXRjaGVyKGhlYWRpbmdJZCk7XG4gIH1cblxuICBoZWFkaW5nRXZlbnRTdWIgPSBMb2NhdGlvbkV2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcihcbiAgICAnRXhwb25lbnQuaGVhZGluZ0NoYW5nZWQnLFxuICAgICh7IHdhdGNoSWQsIGhlYWRpbmcgfSkgPT4ge1xuICAgICAgY29uc3QgY2FsbGJhY2sgPSB3YXRjaENhbGxiYWNrc1t3YXRjaElkXTtcbiAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICBjYWxsYmFjayhoZWFkaW5nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIEV4cG9uZW50TG9jYXRpb24ucmVtb3ZlV2F0Y2hBc3luYyh3YXRjaElkKTtcbiAgICAgIH1cbiAgICB9XG4gICk7XG5cbiAgaGVhZGluZ0lkID0gX2dldE5leHRXYXRjaElkKCk7XG4gIHdhdGNoQ2FsbGJhY2tzW2hlYWRpbmdJZF0gPSBjYWxsYmFjaztcbiAgYXdhaXQgRXhwb25lbnRMb2NhdGlvbi53YXRjaERldmljZUhlYWRpbmcoaGVhZGluZ0lkKTtcbiAgcmV0dXJuIHtcbiAgICByZW1vdmUoKSB7XG4gICAgICBfcmVtb3ZlSGVhZGluZ1dhdGNoZXIoaGVhZGluZ0lkKTtcbiAgICB9LFxuICB9O1xufVxuXG4vLyBSZW1vdmVzIHRoZSBjb21wYXNzIGxpc3RlbmVyIGFuZCBzdWIgZnJvbSBKUyBhbmQgTmF0aXZlXG5mdW5jdGlvbiBfcmVtb3ZlSGVhZGluZ1dhdGNoZXIod2F0Y2hJZCkge1xuICBpZiAoIXdhdGNoQ2FsbGJhY2tzW3dhdGNoSWRdKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGRlbGV0ZSB3YXRjaENhbGxiYWNrc1t3YXRjaElkXTtcbiAgRXhwb25lbnRMb2NhdGlvbi5yZW1vdmVXYXRjaEFzeW5jKHdhdGNoSWQpO1xuICBMb2NhdGlvbkV2ZW50RW1pdHRlci5yZW1vdmVTdWJzY3JpcHRpb24oaGVhZGluZ0V2ZW50U3ViKTtcbiAgaGVhZGluZ0V2ZW50U3ViID0gbnVsbDtcbn1cbi8vIEVuZCBDb21wYXNzIE1vZHVsZVxuXG5mdW5jdGlvbiBfbWF5YmVJbml0aWFsaXplRW1pdHRlclN1YnNjcmlwdGlvbigpIHtcbiAgaWYgKCFkZXZpY2VFdmVudFN1YnNjcmlwdGlvbikge1xuICAgIGRldmljZUV2ZW50U3Vic2NyaXB0aW9uID0gTG9jYXRpb25FdmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoXG4gICAgICAnRXhwb25lbnQubG9jYXRpb25DaGFuZ2VkJyxcbiAgICAgICh7IHdhdGNoSWQsIGxvY2F0aW9uIH0pID0+IHtcbiAgICAgICAgY29uc3QgY2FsbGJhY2sgPSB3YXRjaENhbGxiYWNrc1t3YXRjaElkXTtcbiAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgY2FsbGJhY2sobG9jYXRpb24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIEV4cG9uZW50TG9jYXRpb24ucmVtb3ZlV2F0Y2hBc3luYyh3YXRjaElkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gX2Fza1Blcm1pc3Npb25Gb3JXYXRjaEFzeW5jKHN1Y2Nlc3MsIGVycm9yLCBvcHRpb25zLCB3YXRjaElkKSB7XG4gIGxldCB7IHN0YXR1cyB9ID0gYXdhaXQgUGVybWlzc2lvbnMuYXNrQXN5bmMoUGVybWlzc2lvbnMuTE9DQVRJT04pO1xuICBpZiAoc3RhdHVzID09PSAnZ3JhbnRlZCcpIHtcbiAgICBFeHBvbmVudExvY2F0aW9uLndhdGNoUG9zaXRpb25JbXBsQXN5bmMod2F0Y2hJZCwgb3B0aW9ucyk7XG4gIH0gZWxzZSB7XG4gICAgX3JlbW92ZVdhdGNoZXIod2F0Y2hJZCk7XG4gICAgZXJyb3IoeyB3YXRjaElkLCBtZXNzYWdlOiAnTm8gcGVybWlzc2lvbiB0byBhY2Nlc3MgbG9jYXRpb24nIH0pO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlb2NvZGVBc3luYyhhZGRyZXNzOiBzdHJpbmcpIHtcbiAgcmV0dXJuIEV4cG9uZW50TG9jYXRpb24uZ2VvY29kZUFzeW5jKGFkZHJlc3MpLmNhdGNoKGVycm9yID0+IHtcbiAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJyAmJiBlcnJvci5jb2RlID09PSAnRV9OT19HRU9DT0RFUicpIHtcbiAgICAgIGlmICghZ29vZ2xlQXBpS2V5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvci5tZXNzYWdlICsgJyBQbGVhc2Ugc2V0IGEgR29vZ2xlIEFQSSBLZXkgdG8gdXNlIGdlb2NvZGluZy4nKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBfZ29vZ2xlR2VvY29kZUFzeW5jKGFkZHJlc3MpO1xuICAgIH1cbiAgICB0aHJvdyBlcnJvcjtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJldmVyc2VHZW9jb2RlQXN5bmMobG9jYXRpb246IHsgbGF0aXR1ZGU6IG51bWJlciwgbG9uZ2l0dWRlOiBudW1iZXIgfSkge1xuICBpZiAodHlwZW9mIGxvY2F0aW9uLmxhdGl0dWRlICE9PSAnbnVtYmVyJyB8fCB0eXBlb2YgbG9jYXRpb24ubG9uZ2l0dWRlICE9PSAnbnVtYmVyJykge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAnTG9jYXRpb24gc2hvdWxkIGJlIGFuIG9iamVjdCB3aXRoIG51bWJlciBwcm9wZXJ0aWVzIGBsYXRpdHVkZWAgYW5kIGBsb25naXR1ZGVgLidcbiAgICApO1xuICB9XG4gIHJldHVybiBFeHBvbmVudExvY2F0aW9uLnJldmVyc2VHZW9jb2RlQXN5bmMobG9jYXRpb24pLmNhdGNoKGVycm9yID0+IHtcbiAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJyAmJiBlcnJvci5jb2RlID09PSAnRV9OT19HRU9DT0RFUicpIHtcbiAgICAgIGlmICghZ29vZ2xlQXBpS2V5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvci5tZXNzYWdlICsgJyBQbGVhc2Ugc2V0IGEgR29vZ2xlIEFQSSBLZXkgdG8gdXNlIGdlb2NvZGluZy4nKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBfZ29vZ2xlUmV2ZXJzZUdlb2NvZGVBc3luYyhsb2NhdGlvbik7XG4gICAgfVxuICAgIHRocm93IGVycm9yO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gc2V0QXBpS2V5KGFwaUtleTogc3RyaW5nKSB7XG4gIGdvb2dsZUFwaUtleSA9IGFwaUtleTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX2dvb2dsZUdlb2NvZGVBc3luYyhhZGRyZXNzOiBzdHJpbmcpIHtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmV0Y2goYCR7Z29vZ2xlQXBpVXJsfT9rZXk9JHtnb29nbGVBcGlLZXl9JmFkZHJlc3M9JHtlbmNvZGVVUkkoYWRkcmVzcyl9YCk7XG4gIGNvbnN0IHJlc3VsdE9iamVjdCA9IGF3YWl0IHJlc3VsdC5qc29uKCk7XG5cbiAgaWYgKHJlc3VsdE9iamVjdC5zdGF0dXMgIT09ICdPSycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0FuIGVycm9yIG9jY3VycmVkIGR1cmluZyBnZW9jb2RpbmcuJyk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0T2JqZWN0LnJlc3VsdHMubWFwKHJlc3VsdCA9PiB7XG4gICAgbGV0IGxvY2F0aW9uID0gcmVzdWx0Lmdlb21ldHJ5LmxvY2F0aW9uO1xuICAgIHJldHVybiB7XG4gICAgICBsYXRpdHVkZTogbG9jYXRpb24ubGF0LFxuICAgICAgbG9uZ2l0dWRlOiBsb2NhdGlvbi5sbmcsXG4gICAgfTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIF9nb29nbGVSZXZlcnNlR2VvY29kZUFzeW5jKG9wdGlvbnM6IHsgbGF0aXR1ZGU6IG51bWJlciwgbG9uZ2l0dWRlOiBudW1iZXIgfSkge1xuICBjb25zdCByZXN1bHQgPSBhd2FpdCBmZXRjaChcbiAgICBgJHtnb29nbGVBcGlVcmx9P2tleT0ke2dvb2dsZUFwaUtleX0mbGF0bG5nPSR7b3B0aW9ucy5sYXRpdHVkZX0sJHtvcHRpb25zLmxvbmdpdHVkZX1gXG4gICk7XG4gIGNvbnN0IHJlc3VsdE9iamVjdCA9IGF3YWl0IHJlc3VsdC5qc29uKCk7XG5cbiAgaWYgKHJlc3VsdE9iamVjdC5zdGF0dXMgIT09ICdPSycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0FuIGVycm9yIG9jY3VycmVkIGR1cmluZyBnZW9jb2RpbmcuJyk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0T2JqZWN0LnJlc3VsdHMubWFwKHJlc3VsdCA9PiB7XG4gICAgbGV0IGFkZHJlc3MgPSB7fTtcbiAgICByZXN1bHQuYWRkcmVzc19jb21wb25lbnRzLmZvckVhY2goY29tcG9uZW50ID0+IHtcbiAgICAgIGlmIChjb21wb25lbnQudHlwZXMuaW5jbHVkZXMoJ2xvY2FsaXR5JykpIHtcbiAgICAgICAgYWRkcmVzcy5jaXR5ID0gY29tcG9uZW50LmxvbmdfbmFtZTtcbiAgICAgIH0gZWxzZSBpZiAoY29tcG9uZW50LnR5cGVzLmluY2x1ZGVzKCdzdHJlZXRfYWRkcmVzcycpKSB7XG4gICAgICAgIGFkZHJlc3Muc3RyZWV0ID0gY29tcG9uZW50LmxvbmdfbmFtZTtcbiAgICAgIH0gZWxzZSBpZiAoY29tcG9uZW50LnR5cGVzLmluY2x1ZGVzKCdhZG1pbmlzdHJhdGl2ZV9hcmVhX2xldmVsXzEnKSkge1xuICAgICAgICBhZGRyZXNzLnJlZ2lvbiA9IGNvbXBvbmVudC5sb25nX25hbWU7XG4gICAgICB9IGVsc2UgaWYgKGNvbXBvbmVudC50eXBlcy5pbmNsdWRlcygnY291bnRyeScpKSB7XG4gICAgICAgIGFkZHJlc3MuY291bnRyeSA9IGNvbXBvbmVudC5sb25nX25hbWU7XG4gICAgICB9IGVsc2UgaWYgKGNvbXBvbmVudC50eXBlcy5pbmNsdWRlcygncG9zdGFsX2NvZGUnKSkge1xuICAgICAgICBhZGRyZXNzLnBvc3RhbENvZGUgPSBjb21wb25lbnQubG9uZ19uYW1lO1xuICAgICAgfSBlbHNlIGlmIChjb21wb25lbnQudHlwZXMuaW5jbHVkZXMoJ3BvaW50X29mX2ludGVyZXN0JykpIHtcbiAgICAgICAgYWRkcmVzcy5uYW1lID0gY29tcG9uZW50LmxvbmdfbmFtZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gYWRkcmVzcztcbiAgfSk7XG59XG5cbi8vIFBvbHlmaWxsOiBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24ud2F0Y2hQb3NpdGlvblxuZnVuY3Rpb24gd2F0Y2hQb3NpdGlvbihcbiAgc3VjY2VzczogR2VvU3VjY2Vzc0NhbGxiYWNrLFxuICBlcnJvcjogR2VvRXJyb3JDYWxsYmFjayxcbiAgb3B0aW9uczogTG9jYXRpb25PcHRpb25zXG4pIHtcbiAgX21heWJlSW5pdGlhbGl6ZUVtaXR0ZXJTdWJzY3JpcHRpb24oKTtcblxuICBjb25zdCB3YXRjaElkID0gX2dldE5leHRXYXRjaElkKCk7XG4gIHdhdGNoQ2FsbGJhY2tzW3dhdGNoSWRdID0gc3VjY2VzcztcbiAgX2Fza1Blcm1pc3Npb25Gb3JXYXRjaEFzeW5jKHN1Y2Nlc3MsIGVycm9yLCBvcHRpb25zLCB3YXRjaElkKTtcblxuICByZXR1cm4gd2F0Y2hJZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gd2F0Y2hQb3NpdGlvbkFzeW5jKG9wdGlvbnM6IExvY2F0aW9uT3B0aW9ucywgY2FsbGJhY2s6IExvY2F0aW9uQ2FsbGJhY2spIHtcbiAgX21heWJlSW5pdGlhbGl6ZUVtaXR0ZXJTdWJzY3JpcHRpb24oKTtcblxuICBjb25zdCB3YXRjaElkID0gX2dldE5leHRXYXRjaElkKCk7XG4gIHdhdGNoQ2FsbGJhY2tzW3dhdGNoSWRdID0gY2FsbGJhY2s7XG4gIGF3YWl0IEV4cG9uZW50TG9jYXRpb24ud2F0Y2hQb3NpdGlvbkltcGxBc3luYyh3YXRjaElkLCBvcHRpb25zKTtcblxuICByZXR1cm4ge1xuICAgIHJlbW92ZSgpIHtcbiAgICAgIF9yZW1vdmVXYXRjaGVyKHdhdGNoSWQpO1xuICAgIH0sXG4gIH07XG59XG5cbi8vIFBvbHlmaWxsOiBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uY2xlYXJXYXRjaFxuZnVuY3Rpb24gY2xlYXJXYXRjaCh3YXRjaElkOiBudW1iZXIpIHtcbiAgX3JlbW92ZVdhdGNoZXIod2F0Y2hJZCk7XG59XG5cbmZ1bmN0aW9uIF9yZW1vdmVXYXRjaGVyKHdhdGNoSWQpIHtcbiAgLy8gRG8gbm90aGluZyBpZiB3ZSBoYXZlIGFscmVhZHkgcmVtb3ZlZCB0aGUgc3Vic2NyaXB0aW9uXG4gIGlmICghd2F0Y2hDYWxsYmFja3Nbd2F0Y2hJZF0pIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBFeHBvbmVudExvY2F0aW9uLnJlbW92ZVdhdGNoQXN5bmMod2F0Y2hJZCk7XG4gIGRlbGV0ZSB3YXRjaENhbGxiYWNrc1t3YXRjaElkXTtcbiAgaWYgKE9iamVjdC5rZXlzKHdhdGNoQ2FsbGJhY2tzKS5sZW5ndGggPT09IDApIHtcbiAgICBMb2NhdGlvbkV2ZW50RW1pdHRlci5yZW1vdmVTdWJzY3JpcHRpb24oZGV2aWNlRXZlbnRTdWJzY3JpcHRpb24pO1xuICAgIGRldmljZUV2ZW50U3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgfVxufVxuXG50eXBlIEdlb1N1Y2Nlc3NDYWxsYmFjayA9IChkYXRhOiBMb2NhdGlvbkRhdGEpID0+IHZvaWQ7XG50eXBlIEdlb0Vycm9yQ2FsbGJhY2sgPSAoZXJyb3I6IGFueSkgPT4gdm9pZDtcblxuZnVuY3Rpb24gZ2V0Q3VycmVudFBvc2l0aW9uKFxuICBzdWNjZXNzOiBHZW9TdWNjZXNzQ2FsbGJhY2ssXG4gIGVycm9yPzogR2VvRXJyb3JDYWxsYmFjayA9ICgpID0+IHt9LFxuICBvcHRpb25zPzogTG9jYXRpb25PcHRpb25zID0ge31cbik6IHZvaWQge1xuICBpbnZhcmlhbnQodHlwZW9mIHN1Y2Nlc3MgPT09ICdmdW5jdGlvbicsICdNdXN0IHByb3ZpZGUgYSB2YWxpZCBzdWNjZXNzIGNhbGxiYWNrLicpO1xuXG4gIGludmFyaWFudCh0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcsICdvcHRpb25zIG11c3QgYmUgYW4gb2JqZWN0LicpO1xuXG4gIF9nZXRDdXJyZW50UG9zaXRpb25Bc3luY1dyYXBwZXIoc3VjY2VzcywgZXJyb3IsIG9wdGlvbnMpO1xufVxuXG4vLyBUaGlzIGZ1bmN0aW9uIGV4aXN0cyB0byBsZXQgdXMgY29udGludWUgdG8gcmV0dXJuIHVuZGVmaW5lZCBmcm9tIGdldEN1cnJlbnRQb3NpdGlvbiwgd2hpbGUgc3RpbGxcbi8vIHVzaW5nIGFzeW5jL2F3YWl0IGZvciB0aGUgaW50ZXJuYWwgaW1wbGVtZW50YXRpb24gb2YgaXRcbmFzeW5jIGZ1bmN0aW9uIF9nZXRDdXJyZW50UG9zaXRpb25Bc3luY1dyYXBwZXIoXG4gIHN1Y2Nlc3M6IEdlb1N1Y2Nlc3NDYWxsYmFjayxcbiAgZXJyb3I6IEdlb0Vycm9yQ2FsbGJhY2ssXG4gIG9wdGlvbnM6IExvY2F0aW9uT3B0aW9uc1xuKTogUHJvbWlzZTwqPiB7XG4gIHRyeSB7XG4gICAgbGV0IHsgc3RhdHVzIH0gPSBhd2FpdCBQZXJtaXNzaW9ucy5hc2tBc3luYyhQZXJtaXNzaW9ucy5MT0NBVElPTik7XG4gICAgaWYgKHN0YXR1cyAhPT0gJ2dyYW50ZWQnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdQZXJtaXNzaW9uIHRvIGFjY2VzcyBsb2NhdGlvbiBub3QgZ3JhbnRlZC4gVXNlciBtdXN0IG5vdyBlbmFibGUgaXQgbWFudWFsbHkgaW4gc2V0dGluZ3MnXG4gICAgICApO1xuICAgIH1cblxuICAgIGxldCByZXN1bHQgPSBhd2FpdCBMb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb25Bc3luYyhvcHRpb25zKTtcbiAgICBzdWNjZXNzKHJlc3VsdCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBlcnJvcihlKTtcbiAgfVxufVxuXG4vLyBQb2x5ZmlsbCBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24gZm9yIGludGVyb3Agd2l0aCB0aGUgY29yZSByZWFjdC1uYXRpdmUgYW5kIHdlYiBBUEkgYXBwcm9hY2ggdG9cbi8vIGdlb2xvY2F0aW9uXG53aW5kb3cubmF2aWdhdG9yLmdlb2xvY2F0aW9uID0ge1xuICBnZXRDdXJyZW50UG9zaXRpb24sXG4gIHdhdGNoUG9zaXRpb24sXG4gIGNsZWFyV2F0Y2gsXG5cbiAgLy8gV2UgZG9uJ3QgcG9seWZpbGwgc3RvcE9ic2VydmluZywgdGhpcyBpcyBhbiBpbnRlcm5hbCBtZXRob2QgdGhhdCBwcm9iYWJseSBzaG91bGQgbm90IGV2ZW4gZXhpc3RcbiAgLy8gaW4gcmVhY3QtbmF0aXZlIGRvY3NcbiAgc3RvcE9ic2VydmluZzogKCkgPT4ge30sXG59O1xuXG5jb25zdCBMb2NhdGlvbiA9IHtcbiAgZ2V0UHJvdmlkZXJTdGF0dXNBc3luYyxcbiAgZ2V0Q3VycmVudFBvc2l0aW9uQXN5bmMsXG4gIHdhdGNoUG9zaXRpb25Bc3luYyxcbiAgZ2V0SGVhZGluZ0FzeW5jLFxuICB3YXRjaEhlYWRpbmdBc3luYyxcbiAgZ2VvY29kZUFzeW5jLFxuICByZXZlcnNlR2VvY29kZUFzeW5jLFxuICBzZXRBcGlLZXksXG5cbiAgLy8gRm9yIGludGVybmFsIHB1cnBvc2VzXG4gIEV2ZW50RW1pdHRlcjogTG9jYXRpb25FdmVudEVtaXR0ZXIsXG4gIF9nZXRDdXJyZW50V2F0Y2hJZCxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IExvY2F0aW9uO1xuIl19